<div class="dialog-container">
    <div class="header-section">
      <h2 class="dialog-title">
        <mat-icon>cloud_download</mat-icon>
        Importar Orden desde SILUCIA
      </h2>
      <p class="dialog-subtitle">
        Ingrese el número de orden para obtener los datos desde el sistema SILUCIA
      </p>
    </div>
  
    <div class="content-section">
      <div class="search-header">
        <mat-icon>search</mat-icon>
        <h3>Buscar Orden</h3>
      </div>
      
      <form [formGroup]="orderForm" class="order-form">
        <div class="search-fields-row">
          <mat-form-field appearance="outline" class="field-numero-orden">
            <mat-label>Número de Orden</mat-label>
            <input 
              matInput 
              formControlName="numeroOrden"
              placeholder="Ej: 00401"
              maxlength="5"
            >
            <mat-icon matSuffix>tag</mat-icon>
            <mat-hint>Ingrese el número de orden de 5 dígitos</mat-hint>
            
            <mat-error *ngIf="hasFieldError('numeroOrden')">
              {{ getFieldError('numeroOrden') }}
            </mat-error>
            
            <mat-error *ngIf="numeroOrdenErrors">
              {{ numeroOrdenErrors }}
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="field-anio">
            <mat-label>Año</mat-label>
            <mat-select formControlName="anio">
              <mat-option *ngFor="let year of anioOptions" [value]="year">
                {{ year }}
              </mat-option>
            </mat-select>
            <mat-icon matSuffix>calendar_today</mat-icon>
            <mat-hint>Seleccione el año</mat-hint>
          </mat-form-field>
        </div>
        
        <div class="form-actions">
          <button 
            mat-raised-button 
            color="primary" 
            type="button"
            (click)="searchOrder()"
            [disabled]="isLoading" 
            class="search-button">
            <mat-icon *ngIf="!isLoading">search</mat-icon>
            <mat-icon *ngIf="isLoading" class="spinning">refresh</mat-icon>
            {{ isLoading ? 'Buscando...' : 'Buscar' }}
          </button>
          
          <button 
            mat-button 
            type="button"
            (click)="clearData()"
            [disabled]="isLoading">
            <mat-icon>clear</mat-icon>
            Limpiar
          </button>
        </div>
      </form>

      <div *ngIf="isLoading" class="loading-container">
        <mat-spinner diameter="50"></mat-spinner>
        <p>Buscando orden en SILUCIA...</p>
      </div>
  
      <div *ngIf="showResults && orderData" class="results-section">
        <div class="results-header">
          <mat-icon>assignment</mat-icon>
          <h3>Detalles de la orden para importar</h3>
        </div>

        <!-- Selector de Items mediante Cards Numeradas Compactas -->
        <div *ngIf="orderData.length >= 1" class="items-navigation">
          <div class="navigation-header">
            <mat-icon>inventory_2</mat-icon>
            <span>Items de la orden: {{ orderData.length }}</span>
          </div>
          
          <div class="item-cards-container">
            <div 
              *ngFor="let item of orderData; let i = index"
              class="item-card"
              [class.active]="selectedItem === item"
              [class.new-item]="item.isNew"
              (click)="selectItem(item)"
              [matTooltip]="getTooltipContent(item)"
              matTooltipPosition="above">
              <div class="card-number">{{ i + 1 }}</div>
              <mat-icon class="check-icon" *ngIf="selectedItem === item">check_circle</mat-icon>
              <mat-icon class="new-badge" *ngIf="item.isNew">fiber_new</mat-icon>
            </div>
            
            <!-- Botón para agregar nuevo item -->
            <button 
              class="item-card add-item-card"
              (click)="addNewItem()"
              [disabled]="isLoading"
              matTooltip="Agregar nuevo item"
              matTooltipPosition="above">
              <mat-icon>add</mat-icon>
            </button>
          </div>
        </div>
  
        <mat-card class="order-card">
          <mat-card-header>
            <div mat-card-avatar class="order-avatar">
              <mat-icon>description</mat-icon>
            </div>
            <mat-card-title>Orden N° {{ selectedItem?.numero }}/{{ selectedItem?.anio }}</mat-card-title>
            <mat-card-subtitle>SIAF: {{ selectedItem?.siaf }}</mat-card-subtitle>
          </mat-card-header>
  
          <mat-card-content>
            <form [formGroup]="importForm" class="import-form">
              <div class="order-details">
                
                <div class="detail-section">
                  <h4 class="section-title">
                    <mat-icon>assignment</mat-icon>
                    Información de la Orden
                  </h4>
                  <div class="detail-row">
                    <div class="detail-item">
                      <strong>Fecha de Prestación:</strong>
                      <span>{{ formatDate(selectedItem?.fecha_prestacion ?? '') }}</span>
                    </div>
                    <div class="detail-item">
                      <strong>Plazo de Prestación:</strong>
                      <span>{{ selectedItem?.plazo_prestacion }} días</span>
                    </div>
                  </div>
                </div>
                <div class="detail-section">
                  <h4 class="section-title">
                    <mat-icon>business</mat-icon>
                    Información del Proveedor
                  </h4>
                  <div class="detail-row">

                    <div class="detail-item">
                      <strong>Ruc Proveedor:</strong>
                      <span>{{ selectedItem?.ruc }}</span>
                    </div>
                    <div class="detail-item">
                      <strong>Razon Social:</strong>
                      <span>{{ selectedItem?.rsocial }}</span>
                    </div>
                  </div>
                </div>

                <div class="detail-section">
                  <h4 class="section-title">
                    <mat-icon>account_tree</mat-icon>
                    Información del Proyecto
                  </h4>
                  <div class="detail-row">
                    <div class="detail-item">
                      <strong>Código de Meta:</strong>
                      <span>{{ selectedItem?.cod_meta }}</span>
                    </div>
                    
                    <div class="detail-item">
                      <strong>Descripción de Meta:</strong>
                      <span>{{ selectedItem?.desmeta }}</span>
                    </div>
                  </div>
                </div>
  
                <div class="detail-section">
                  <div class="operators-header">
                    <h4 class="section-title">
                      <mat-icon>person</mat-icon>
                      Operadores Asignados
                    </h4>
                    <button 
                      mat-mini-fab 
                      color="primary"
                      type="button"
                      (click)="addOperator()"
                      [disabled]="isLoading"
                      matTooltip="Agregar operador">
                      <mat-icon>add</mat-icon>
                    </button>
                  </div>

                  <div formArrayName="operators">
                    <mat-card 
                      *ngFor="let operator of operatorsControls; let i = index" 
                      [formGroupName]="i" 
                      class="operator-card">
                      
                      <div class="operator-card-header">
                        <span class="operator-number">Operador #{{ i + 1 }}</span>
                        <button 
                          mat-icon-button 
                          color="warn"
                          type="button"
                          (click)="removeOperator(i)"
                          [disabled]="operatorsControls.length === 1 || isLoading"
                          matTooltip="Eliminar operador">
                          <mat-icon>delete</mat-icon>
                        </button>
                      </div>

                      <mat-form-field appearance="outline" class="field-full">
                        <mat-label>Nombre del Operador</mat-label>
                        <input 
                          matInput 
                          type="text"
                          formControlName="operatorName"
                          placeholder="Ingrese nombre completo del operador">
                        <mat-icon matSuffix>person</mat-icon>
                        <mat-error *ngIf="operator.get('operatorName')?.hasError('required')">
                          El nombre del operador es requerido
                        </mat-error>
                      </mat-form-field>
                    </mat-card>
                  </div>
                </div>

                <div class="detail-section">
                  <h4 class="section-title">
                    <mat-icon>build</mat-icon>
                    Información de la Maquinaria
                  </h4>
                  
                  <div class="detail-row">
                    <mat-form-field appearance="outline" class="field-medium">
                      <mat-label>Tipo de Maquinaria</mat-label>
                      <mat-select formControlName="tipoMaquinaria">
                        <mat-option *ngFor="let option of tipoMaquinariaOptions" [value]="option.value">
                          {{ option.label }}
                        </mat-option>
                      </mat-select>
                      <mat-icon matSuffix>category</mat-icon>
                    </mat-form-field>
                    
                    <mat-form-field appearance="outline" class="field-medium">
                      <mat-label>Máquina/Equipo</mat-label>
                      <input matInput formControlName="maquinaria">
                      <mat-icon matSuffix>precision_manufacturing</mat-icon>
                    </mat-form-field>
                  </div>
  
                  <div class="detail-row">
                    <mat-form-field appearance="outline" class="field-medium">
                      <mat-label>Marca</mat-label>
                      <input matInput formControlName="marca">
                      <mat-icon matSuffix>business_center</mat-icon>
                    </mat-form-field>
                    
                    <mat-form-field appearance="outline" class="field-medium">
                      <mat-label>Modelo</mat-label>
                      <input matInput formControlName="modelo">
                      <mat-icon matSuffix>inventory_2</mat-icon>
                    </mat-form-field>
                  </div>
  
                  <div class="detail-row">
                    <mat-form-field appearance="outline" class="field-medium">
                      <mat-label>Motor/Capacidad</mat-label>
                      <input matInput formControlName="capacidad">
                      <mat-icon matSuffix>settings</mat-icon>
                    </mat-form-field>
                    
                    <mat-form-field appearance="outline" class="field-small">
                      <mat-label>Año</mat-label>
                      <input matInput formControlName="year">
                      <mat-icon matSuffix>calendar_today</mat-icon>
                    </mat-form-field>
                  </div>
  
                  <div class="detail-row">
                    <mat-form-field appearance="outline" class="field-medium">
                      <mat-label>Número de Serie</mat-label>
                      <input matInput formControlName="serie">
                      <mat-icon matSuffix>confirmation_number</mat-icon>
                    </mat-form-field>
                    
                    <mat-form-field appearance="outline" class="field-medium">
                      <mat-label>Placa</mat-label>
                      <input matInput formControlName="placa">
                      <mat-icon matSuffix>local_shipping</mat-icon>
                    </mat-form-field>
                  </div>
                </div>
  
              </div>
            </form>
          </mat-card-content>
  
          <mat-card-actions class="card-actions">
            <button 
              mat-raised-button 
              color="primary"
              (click)="importOrder()"
              [disabled]="isLoading || !areAllItemsValid()">
              <mat-icon>download</mat-icon>
              Importar Orden
            </button>
            <button 
              mat-button
              (click)="clearData()"
              [disabled]="isLoading">
              <mat-icon>refresh</mat-icon>
              Nueva Búsqueda
            </button>
          </mat-card-actions>
        </mat-card>
      </div>
    </div>
  </div>