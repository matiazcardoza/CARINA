<div class="container">
        <!-- <button (click)="verData()">
          see data 
        </button> -->
    <!-- <section class="toolbar">
      <label for="obraSel" class="toolbar__label">Obra:</label>

      @if (obras().length > 0) {
        <div class="toolbar__field">
          <select id="obraSel"
                  class="toolbar__select"
                  [ngModel]="selectedObraId"
                  (ngModelChange)="onObraChange($event)"
                  >
            @for (o of obras(); track o.id) {
              <option [value]="o.id">{{ o.codmeta }} / {{ o.anio }} / {{ o.nombre }} </option>
            }
          </select>
        </div>
      } @else {
        <span class="toolbar__muted">No hay obras disponibles.</span>
      }
    </section> -->
    <!-- <div class="miCajaToken">
      este es mi otro div para probar si las clases corrren correctamente
    </div> -->





    <!-- <div class="card flex justify-center" style="max-width:16rem; background: pink; border: 3px solid red;">

      <p-select 
          [options]="obras()"
          [ngModel]="selectedObraId"
          (ngModelChange)="onObraChange($event)"
          optionValue="id" 
          optionLabel="nombre" 
          [filter]="true" 
          filterBy="nombre,codmeta,anio" 
          [showClear]="false" 
          placeholder="Selecciona una obra" 
          class="w-full md:w-56" 
          style="width: 100%;"
      > -->
        <!-- [(ngModel)]="selectedCountry"  -->
          <!-- <ng-template #selectedItem let-selectedOption>
              <div class="flex items-center gap-2"> -->
                  <!-- <img src="https://primefaces.org/cdn/primeng/images/demo/flag/flag_placeholder.png" [class]="'flag flag-' + selectedCountry.code.toLowerCase()" style="width: 18px" /> -->
                  <!-- <div>{{ selectedOption.name }}</div>
              </div>
          </ng-template> -->

          <!-- <ng-template let-country #item>
              <div class="flex items-center gap-2">
                  <img src="https://primefaces.org/cdn/primeng/images/demo/flag/flag_placeholder.png" [class]="'flag flag-' + country.code.toLowerCase()" style="width: 18px" />
                  <div>{{ country.name }}</div>
              </div>
          </ng-template> -->
          
      <!-- </p-select>

    </div> -->





    <div class="card">

        <div class="welcome_message_container">
            <div>
                  <h1 style="margin: 0; margin-bottom: 0.5rem;">Gestión del Kardex</h1>
                  <p  style="margin: 0;">Seleccione la orden de compra para registrar el movimiento.</p>
            </div>

            <div class="select_container">
              <p-select 
                  [options]="obras()"
                  [ngModel]="selectedObraId"
                  (ngModelChange)="onObraChange($event)"
                  optionValue="id" 
                  optionLabel="nombre" 
                  [filter]="true" 
                  filterBy="nombre,codmeta,anio" 
                  [showClear]="false" 
                  placeholder="Selecciona una obra" 
                  class="w-full md:w-56" 
                  style="width: 100%;"
              >
                    <ng-template pTemplate="item" let-o>
                      <div class="flex flex-col">
                        <div class="flex items-center gap-2">
                          <span class="font-medium">{{ o.codmeta }} / {{ o.anio }}</span>
                          <span>— {{ o.nombre }}</span>
                        </div>
                        <small class="text-gray-500" *ngIf="o.idmeta_silucia">ID Meta: {{ o.codmeta }}</small>
                      </div>
                    </ng-template>

                    <!-- Cómo se ve el valor seleccionado (la “etiqueta” cerrada) -->
                    <ng-template pTemplate="selectedItem" let-o>
                      <ng-container *ngIf="o; else noSel">
                        {{ o.codmeta }} / {{ o.anio }} / {{ o.nombre }}
                      </ng-container>
                      <ng-template #noSel>Selecciona una obra</ng-template>
                    </ng-template>

              </p-select>
            </div>
        </div>

        <div class="mt-4">
            <!-- <h2 class="text-xl font-semibold mb-2">Tus roles</h2> -->

            @if (myCurrentRoles().length > 0) {
              <div class="p_chip_style">
                @for (item of myCurrentRoles(); track item) {
                  <p-chip
                    [label]="roleMeta[item]?.label"
                    [icon]="roleMeta[item]?.icon"
                    [ngStyle]="roleMeta[item]?.styleClass"
                  >
                  </p-chip>
                }
              </div>
            } @else {
              <h2 severity="warn" text="No tienes roles asignados."></h2>
            }
        </div>


        <div class="search_inputs_container">
          <input 
            pInputText 
            type="text" 
            placeholder='Número "Orden"' 
            style="width: 100%"
            [value]="ordenCompraDetallado().filters.numero"
            (input)="onAddFilters('numero', $event.target.value)"
            [style]="{ 'max-width': '10rem', 'margin-left': 'auto' }"
          />

          <input 
            pInputText 
            type="number" 
            placeholder="Año" 
            style="width: 100%"
            [value]="ordenCompraDetallado().filters.anio"
            (input)="onAddFilters('anio', $event.target.value)"
            [style]="{ 'max-width': '10rem' }"
          />

          <!-- <input 
            pInputText 
            type="text" 
            placeholder="Ítem (opcional)" 
            disabled 
            style="width: 100%"
          />

          <input 
            pInputText 
            type="text" 
            placeholder="Meta (opcional)" 
            disabled 
            style="width: 100%"
          /> -->

          <div class="search_item">
            <p-button
                [style]="{ 'max-width': '3rem' }"
                label="" 
                icon="pi pi-search" 
                (onClick)="search()"
            ></p-button>

            <p-button 
                [style]="{ 'max-width': '3rem' }"
                severity="secondary" 
                outlined
                icon="pi pi-times"    
                (onClick)="cleanFilters()"
            ></p-button>
          </div>
        </div>  

        <p-table
            [loading]="ordenCompraDetallado().loading"
            paginatorDropdownAppendTo="body"

            [value]="ordenCompraDetallado().value"
            [rows]="ordenCompraDetallado().rows"
            [paginator]="true"

            [first]="ordenCompraDetallado().first"
            [totalRecords]="ordenCompraDetallado().totalRecords"

            (onLazyLoad)="onLazyLoadPecosa($event)"
            [rowsPerPageOptions]="ordenCompraDetallado().rowsPerPageOptions"
            [lazy]="true"

            [lazyLoadOnInit]="false"

            selectionMode="single"
            [(selection)]="selectedProduct"
            
            [scrollable]="true"
            scrollDirection="both"

            dataKey="id"
            [expandedRowKeys]="expandedRowsPecosa()"
            (onRowExpand)="onRowExpandPecosa($event)"
            (onRowCollapse)="onRowCollapsePecosa($event)"
        >
          <!-- Filtros en el caption -->


          <!-- Header -->
          <ng-template pTemplate="header">
            <tr>
              <th></th>
              <th>Id</th>
              <th><div class="item_head">Año</div></th>
              <th style="min-width:7rem;"><div class="item_head">Fecha</div></th>
              <th style="min-width:8rem;"><div class="item_head">N° PECOSA</div></th>
              <th style="min-width:8rem;"><div class="item_head">ID Item (Silucia)</div></th>
              <th style="min-width:8rem;"><div class="item_head">Reportes</div></th>
              <th><div class="item_head">Cantidad</div></th>

              <th><div class="item_head">Entradas</div></th>
              <th><div class="item_head">Salidas</div></th>
              <th><div class="item_head">Stock</div></th>

              <th><div class="item_head">Precio</div></th>
              <th><div class="item_head">Medida</div></th>
              <th><div class="item_head">Ítem</div></th>
              <th><div class="item_head">prod_proy</div></th>
              <th style="min-width:7rem;"><div class="item_head">N° Meta</div></th>
              <th><div class="item_head">Meta</div></th>
              <th><div class="item_head">desuoper</div></th>
              <th><div class="item_head">destipodestino</div></th>

              <!-- Acciones congeladas a la derecha -->
              <th pFrozenColumn alignFrozen="right" [style]="{ width: '150px', textAlign: 'center' }">
                <span class="flex items-center gap-2">Acciones <i class="pi pi-cog text-gray-500"></i></span>
              </th>
            </tr>
          </ng-template>

          <!-- Body -->
          <ng-template pTemplate="body" let-row>
            <tr>
              <td>
                <p-button
                  [pRowToggler]="row"
                  [text]="true"
                  [rounded]="true"
                  severity="secondary"
                  [disabled]="!(row?.reports?.length)"
                  [icon]="(expandedRowsPecosa()[row.id] ? 'pi pi-chevron-down' : 'pi pi-chevron-right')">
                </p-button>
              </td>
              <td>{{ row.id }}</td>
              <td>{{ row.anio }}</td>
              <td>{{ row.fecha | date: 'dd/MM/yyyy' }}</td>
              <td>{{ row.numero }}</td>
              <td>{{ row.idsalidadet_silucia }}</td>
              
              <td>
                <p-badge [value]="row.number_reports" [severity]="getReportSeverity(row.number_reports)"></p-badge>
              </td>
              <td>{{ row.cantidad }}</td>
              <td>
                <p-badge [value]="row.quantity_received" [severity]="'success'"></p-badge>
              </td>
              <td>
                <p-badge [value]="row.quantity_issued" [severity]="'warn'"></p-badge>
              </td>
              <td>
                <p-badge [value]="row.quantity_on_hand" [severity]="'info'"></p-badge>
              </td>


              <td>{{ row.precio }}</td>
              <td>{{ row.desmedida }}</td>
              <td style="padding:0; min-width:12rem;">
                <div style="max-height:120px; overflow:auto; line-height:1.35; padding:6px 8px; text-align:justify; word-break:break-word;">
                  {{ row.item }}
                </div>
              </td>
              <td>{{ row.prod_proy }}</td>
              <td>{{ row.cod_meta }}</td>
              <td style="padding:0; min-width:12rem;">
                <div style="max-height:120px; overflow:auto; line-height:1.35; padding:6px 8px; text-align:justify; word-break:break-word;">
                {{ row.desmeta }}
                </div>
              </td>
              <td>{{ row.desuoper }}</td>
              <td>{{ row.destipodestino }}</td>

              <!-- Acciones (columna congelada) -->
              <td pFrozenColumn alignFrozen="right">
                <div class="flex container_action_buttons gap-2">
                                          <!-- [style]="{ width: '2.5rem', height: '2.5rem', 'border-radius': '50%' }" -->

                  <p-button icon="pi pi-eye" severity="info"  (onClick)="openMovementDetailsModal(row)"></p-button>
                  <p-button icon="pi pi-plus" severity="success" (onClick)="openMovementModal(row)"></p-button>
                  <p-button icon="pi pi-file-pdf" severity="danger" (onClick)="generatePdf(row)"></p-button>
                </div>
              </td>
            </tr>
          </ng-template>

          <!-- <ng-template pTemplate="expandedrow" let-row>
            fila expandida
          </ng-template> -->
          <ng-template pTemplate="expandedrow" let-row>
            
            <tr>
              <td colspan="13">
                <!-- <td [attr.colspan]="columns.length"> -->
                <!-- <div style="padding:10px 8px; background:#f9fafb; border:1px solid #e5e7eb;border-radius:8px;"> -->
                <div style="padding:10px 8px; background:#f9fafb; border:1px solid #e5e7eb; border-radius:8px; text-align:center; min-width: 50%; background: rgb(240, 240, 240);">
                  <h4 style="margin:0 0 8px 0; font-size:1rem;">Reportes del ítem</h4>

                  <p-table [value]="row.reports || []">

                    <ng-template pTemplate="header">
                      <tr>
                        <th style="min-width:1rem;">Id</th>
                        <!-- <th style="min-width:1rem;">Tipo</th> -->
                        <th style="min-width:1rem;">Estado de documento</th>
                        <th style="min-width:1rem;">Firmante autorizado</th>
                        <th style="min-width:1rem;">Puede firmar</th>
                        <!-- <th style="min-width:1rem;">Puede firmar</th> -->
                        <th style="min-width:1rem; text-align:center;">Acciones</th>
                      </tr>
                    </ng-template>

                    <ng-template pTemplate="body" let-r>
                      <tr>
                        <td>{{ r.id }}</td>
                        <td>{{getStatusLabel(r.status)}}</td>
                        <td>{{ getAuthorizedSignatoryLabel(r.current_step.role) || '—' }}</td>

                        @if(r.can_you_sign){
                          <td>SI</td>
                        }@else {
                          <td >NO</td>
                        }

                        <td style="text-align:end;">
                          <div class="flex gap-2 justify-center" style="display: flex; gap: 0.5rem; justify-content: center;">
                            <p-button
                              icon="pi pi-download"
                              severity="secondary"
                              [text]="true" 
                              pTooltip="Descargar PDF"
                              tooltipPosition="top"
                              [style]="{ width: '2.5rem', height: '2.5rem', 'border-radius': '50%' }"
                              (onClick)="downloadReport(r.pdf_path)"
                            ></p-button>
                              <!-- styleClass="rounded-full" -->
                              <!-- (onClick)="downloadReport(r.status)" -->

                            <p-button
                              icon="pi pi-pencil"
                              severity="success"
                              [text]="true" 
                              pTooltip="firmar digitalmente"
                              [style]="{ width: '2.5rem', height: '2.5rem', 'border-radius': '50%' }"
                              (onClick)="signReport(r)"
                            ></p-button>
                              <!-- styleClass="rounded-full" -->

                            <p-button
                              icon="pi pi-trash"
                              severity="danger"
                              [text]="true" 
                              styleClass="rounded-full"
                              pTooltip="eliminar reporte"
                              [style]="{ width: '2.5rem', height: '2.5rem', 'border-radius': '50%' }"
                              (onClick)="deleteReport(r)"
                            ></p-button>
                              <!-- [disabled]="!r.can_sign || !r.sign_callback_url" -->
                          </div>
                        </td>
                      </tr>
                    </ng-template>

                    <ng-template pTemplate="emptymessage">
                      <tr><td colspan="6">Sin reportes.</td></tr>
                    </ng-template>

                  </p-table>
                  
                </div>
              </td>
              <!-- </td> -->
            </tr>
          </ng-template>

          <ng-template pTemplate="emptymessage">
            <tr><td colspan="14">No se encontraron registros.</td></tr>
          </ng-template>
        </p-table>
    </div>

    <!-- ------------------Modal: Registrar movimiento-------------------------------- -->
    <p-dialog
      header="Registrar movimiento"
      [(visible)]="showMovementModal"
      [modal]="true"
      [closable]="true"
      [style]="{ width: '450px' }"
    >
        <!-- <button (click)="verData()">
          see data 
        </button> -->
      <div class="p-fluid container_dialog">
        <!-- Tipo -->
        <div class="field dialog_item">
          <span style="display:block; font-weight:bold; margin-bottom:0.5rem;">Tipo de movimiento</span>
          <div style="display:flex;">

            <div style="flex-grow:1; display:flex; gap:0.5rem; align-items:center;">
              <p-radiobutton 
                [inputId]="'movEntrada'" 
                name="movement_type" 
                [value]="'entrada'" 
                [ngModel]="formx().movement_type"
                (ngModelChange)="setMovementType('entrada', $event)"
              />

              <label for="movEntrada">Entrada</label>
            </div>

            <div style="flex-grow:1; display:flex; gap:0.5rem; align-items:center;">
              <p-radiobutton 
                  [inputId]="'movSalida'" 
                  name="movement_type" 
                  [value]="'salida'"
                  [ngModel]="formx().movement_type"
                  (ngModelChange)="setMovementType('salida', $event)" 
              />
              <label for="movSalida">Salida</label>
            </div>
            
          </div>
        </div>

        @if (formx().movement_type == 'salida') {
          <div class="field dialog_item">
            <select
              id="operarioSel"
              class="toolbar__select"
              [ngModel]="selectedOperarioId()"
              (ngModelChange)="onOperarioChange($event)"
            >
              <option [ngValue]="null" disabled selected>Selecciona operario</option>
              @for (u of operarios(); track u.id) {
                <option [ngValue]="u.id">{{ u.label }}</option>
              }
            </select>
          </div>
        }


        <!-- Cantidad -->
        <div class="field dialog_item">
          <label for="cantidad" style="display:block; font-weight:bold; margin-bottom:0.5rem;">Cantidad</label>
          <p-inputNumber 
              inputId="cantidad" 
              [min]="1" 
              [useGrouping]="false" 
              [showButtons]="true"
              [ngModel]="formx().amount"
              (ngModelChange)="setMovementType('cantidad', $event)" 
          ></p-inputNumber>
        </div>

        <!-- Fecha de movimiento -->
        <div class="field dialog_item">
          <label for="cantidad" style="display:block; font-weight:bold; margin-bottom:0.5rem;">Fecha movimiento</label>
          <!-- [(ngModel)]="datetime24h" -->
          <p-datepicker 
              inputId="calendar-24h" 
              [ngModel]="formx().movement_date"
              (ngModelChange)="setMovementType('time', $event)"
              [showTime]="true" 
              [hourFormat]="'24'"
              (onShow)="primeSetToday()"
              appendTo="body" 
          />

        </div>

        <!-- Observaciones -->
        <div class="field dialog_item">
          <label for="observations" style="display:block; font-weight:bold; margin-bottom:0.5rem;">Observaciones</label>
          <textarea 
              id="observations" 
              pInputTextarea 
              rows="3" 
              cols="30" 
              placeholder="Escribe tus observaciones aquí" 
              class="text-area"
              [ngModel]="formx().observations"
              (ngModelChange)="setMovementType('observations', $event)" 
          >
              <!-- [(ngModel)]="form.observations"  -->
          </textarea>
        </div>

        <!-- Personas -->
        @if (formx().movement_type == 'salida') {
          <div class="field dialog_people">
            <div class="flex items-center justify-between dialog_people_item">
              <span class="font-medium">Añadir nuevo operario</span>
              <p-button 
                icon="pi pi-user-plus" 
                (onClick)="OpenModalAddPerson()" 
                [rounded]="true" 
                [text]="true" 
                [ariaLabel]="'Adicionar persona'"
              ></p-button>
            </div>
          </div>
        }

        @if (listDniPeople().length > 0) {
          <p-listbox [options]="listDniPeople()" [style]="{ width: '100%' }" [filter]="false">
            <ng-template let-item pTemplate="item">
              <div style="display:flex; flex-direction:column; gap:0.25rem;">
                <span><strong>DNI:</strong> {{ item.dni }}</span>
                <span><strong>Nombre:</strong> {{ item.names }}</span>
                <span><strong>Apellido paterno:</strong> {{ item.first_lastname }}</span>
                <span><strong>Apellido materno:</strong> {{ item.second_lastname }}</span>
              </div>
            </ng-template>
          </p-listbox>
        }
      </div>

      <ng-template pTemplate="footer">

        <div style="display:flex; justify-content:flex-end; gap:0.5rem; width:100%;">
          <p-button 
              label="Cancelar" 
              severity="secondary" 
              outlined 
              (onClick)="closeMovementModal()"
          ></p-button>
          <p-button 
              label="Aceptar" 
              icon="pi pi-check" 
              [disabled]="!formx().movement_type || !formx().amount" 
              [loading]="savingMovementLoading()"
              (onClick)="onSubmitMovement()" 
          ></p-button>
        </div>

      </ng-template>
    </p-dialog>

    <!-- ------------------ Modal: Detalles de movimientos -------------------- -->
    <app-see-movements-details-modal
      [isOpen]="showMovementsDetails"
      (isOpenChange)="showMovementsDetails = false"
      [obraId]="selectedObraId"
      [ordenCompraDetalladoId]="ordenCompraDetalladoId"
    >

    </app-see-movements-details-modal>
    

    <!-- Modal para buscar y anexar persona por DNI -->
    <app-add-new-user-modal
      [isOpen]="showAddUserModal"
      (isOpenChange)="closeModalAddPerson()"
      (onListPeopleByDni)="handleListPeopleByDni($event)"
      (onAddNewOperario)="getUsersOfMovementKardex()"
      [obraId]="selectedObraId"
    />

    <p-toast />
</div>