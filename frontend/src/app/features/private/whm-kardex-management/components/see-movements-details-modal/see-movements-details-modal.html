<p-dialog 
    header="Detalles de movimientos" 
    [visible]="isOpen()"
    (visibleChange)="handleOpen()"
    [closable]="true"
    [modal]="true" 
    [style]="{maxWidth: 'calc(100vw - 2rem)'}"
    [contentStyle]="{ 'overflow': 'auto' }"
>

    <div style="max-width: 100%; overflow: auto;">
      <p-table
        [loading]="movementDetails().loading"
        paginatorDropdownAppendTo="body"

        [value]="movementDetails().value"
        [rows]="movementDetails().rows"
        [paginator]="true"

        [first]="movementDetails().first"
        [totalRecords]="movementDetails().totalRecords"

        (onLazyLoad)="onLazyLoadMovementDetails($event)"
        [rowsPerPageOptions]="movementDetails().rowsPerPageOptions"
        [lazy]="true"
        
        [lazyLoadOnInit]="false"

        [scrollable]="true" 
        scrollDirection="both"

        dataKey="id"
      >

        <ng-template pTemplate="header">
          <tr>
            <th></th>
            <th pSortableColumn="id">ID </th>
            <th pSortableColumn="movement_type">Tipo </th>
            <th pSortableColumn="amount">Cantidad</th>
            <th pSortableColumn="observations" style="max-width:200px;">Observaciones </th>
            <th pSortableColumn="movement_date">Fecha </th>
          </tr>
        </ng-template>

        <ng-template pTemplate="body" let-movement let-expanded="expanded">
          <tr>
            <td>
              <p-button type="button" [pRowToggler]="movement" [disabled]="!movement?.users?.length" [text]="true" [rounded]="true" severity="secondary" [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'">
              </p-button>
            </td>
            <td>{{ movement.id }}</td>
            <td>{{ movement.movement_type }}</td>
            <td>{{ movement.amount }}</td>
            <td style="max-width:300px; width:300px; padding:0;">
              <div style="max-height:84px; overflow-y:auto; line-height:1.35; text-align:justify; padding:6px 8px; word-break:break-word;">
                {{ movement.observations || 'ninguna' }}
              </div>
            </td>
            <td>{{ formatServerYmdHm(movement.movement_date)}}</td>
          </tr>
        </ng-template>

        <ng-template pTemplate="expandedrow" let-movement>
          <tr>
            <td colspan="6">
              <div style="padding:10px 8px; background:#f9fafb; border:1px solid #e5e7eb; border-radius:8px;">
                <h4 style="margin:0 0 8px 0; font-size:1rem;">Personas anexadas</h4>

                <p-table [value]="movement.users || []">

                  <ng-template pTemplate="header">
                    <tr>
                      <th style="width:8rem;">DNI</th>
                      <th>Nombre completo</th>
                      <th style="width:11rem;">Adjuntado</th>
                    </tr>
                  </ng-template>

                  <ng-template pTemplate="body" let-person>
                    <tr>
                      <td>{{ person.persona?.num_doc || 'â€”' }}</td>
                      <td>
                        {{
                          person.persona?.name
                            ? (person.persona?.name + (person.persona?.last_name ? ' ' + person.persona?.last_name : ''))
                            : person.name
                        }}
                      </td>
                      <td>{{ formatServerYmdHm(person.pivot?.attached_at)}}</td>
                    </tr>
                  </ng-template>

                  <ng-template pTemplate="emptymessage">
                    <tr><td colspan="3">Sin personas anexadas.</td></tr>
                  </ng-template>
                </p-table>
              </div>
            </td>
          </tr>
        </ng-template>

        <ng-template pTemplate="emptymessage">
          <tr><td colspan="6">Sin movimientos.</td></tr>
        </ng-template>
      </p-table>
    </div>

    <ng-template pTemplate="footer">
      <div style="display:flex; justify-content:flex-end; gap:0.5rem; width:100%;">
        <p-button 
            label="Cerrar"
            (onClick)="handleOpen()" 
        ></p-button>

      </div>
    </ng-template>
</p-dialog>

<p-toast />