<div class="card">
  <div>
    <h1 class="text-3xl font-semibold mb-2">Órdenes de Combustible</h1>
    <p class="text-lg text-gray-500">Lista y estado de aprobación de las órdenes de atención de combustible.</p>
  </div>
  
  <div class="flex justify-end mb-3" style="display: flex; justify-content: end; margin-bottom: 1rem;">
    <p-button
      label="Nueva orden"
      icon="pi pi-plus"
      (onClick)="openNewModal()">
    </p-button>
  </div>


  <p-table
    #dt1
    [value]="orders()"
    [paginator]="true"
    [rows]="pageSize"
    [totalRecords]="ordersTotal()"
    [lazy]="true"
    (onLazyLoad)="onOrdersLazyLoad($event)"

    [globalFilterFields]="['numero','fecha','vehiculo_placa','fuel_type','quantity_gal','amount_soles','supervisor_status','manager_status']"
    selectionMode="single"
    [(selection)]="selectedOrder"
    dataKey="id"

    stateStorage="session"
    stateKey="fuelorders-session"
    [scrollable]="true"
    scrollDirection="both"
    [tableStyle]="{ 'min-width': '70rem' }"
    [loading]="loadingOrders()"
  >
    <!-- CAPTION (filtros) -->
  <ng-template pTemplate="caption">
    <div
      style="
        display: flex;
        align-items: center;
        gap: 1rem;
        width: 100%;
      "
    >
      <p-iconfield style="width: 350px;">
        <p-inputicon><i class="pi pi-search"></i></p-inputicon>
        <input
          pInputText
          type="text"
          [value]="uiFilters().placa"
          (input)="onFilterChange('placa', $event)"
          placeholder="Ingrese término para búsqueda"
          style="width: 100%;"
        />
      </p-iconfield>

      <!-- <div style="display: flex; gap: 0.5rem; margin-left: auto;">
        <p-button
          label="Buscar"
          icon="pi pi-search"
          (onClick)="onSearchClick()"
        ></p-button>
        <p-button
          label="Limpiar"
          severity="secondary"
          outlined
          (onClick)="onClearClick()"
        ></p-button>
      </div> -->
    </div>
  </ng-template>

    <!-- HEADER -->
    <ng-template pTemplate="header">
      <tr>
        <th style="width:8%"><div class="item_head">N° Orden</div></th>
        <th style="width:9%"><div class="item_head">Fecha</div></th>
        <th style="width:10%"><div class="item_head">Placa</div></th>
        <th style="width:10%"><div class="item_head">Combustible</div></th>
        <th style="width:8%"><div class="item_head">Glns</div></th>
        <th style="width:10%"><div class="item_head">Importe (S/)</div></th>
        <th style="width:12%"><div class="item_head">Supervisor</div></th>
        <th style="width:12%"><div class="item_head">Jefe</div></th>
        <th pFrozenColumn alignFrozen="right" [style]="{ width: '160px', textAlign: 'center' }">
          <span class="flex items-center gap-2">
            Acciones
            <i class="pi pi-cog text-gray-500"></i>
          </span>
        </th>
      </tr>
    </ng-template>

    <!-- BODY -->
    <ng-template pTemplate="body" let-order>
      <tr>
        <td>{{ order.numero || '—' }}</td>
        <td>{{ order.fecha | date:'dd/MM/yyyy' }}</td>
        <td>{{ order.vehiculo_placa || order.vehicle?.plate }}</td>
        <td class="text-capitalize">{{ order.fuel_type }}</td>
        <td>{{ order.quantity_gal }}</td>
        <td>{{ order.amount_soles }}</td>

        <td>
          <p-tag
            [value]="(order.supervisor_status ?? 'pendiente')"
            [severity]="order.supervisor_status === 'approved' ? 'success' :
                        order.supervisor_status === 'rejected' ? 'danger' : 'warning'">
          </p-tag>
        </td>
        <td>
          <p-tag
            [value]="(order.manager_status ?? 'pendiente')"
            [severity]="order.manager_status === 'approved' ? 'success' :
                        order.manager_status === 'rejected' ? 'danger' : 'warning'">
          </p-tag>
        </td>

      <!-- Acciones -->
      <td pFrozenColumn alignFrozen="right">
        <div class="flex container_action_buttons gap-2" style="display: flex; gap: 1rem;">

          <p-button
            icon="pi pi-file-pdf"
            [disabled]="!canGenerate(order)"
            pTooltip="Crear PDF y flujo de firma"
            tooltipPosition="top"
            (onClick)="generateReport(order)"
            styleClass="p-button-rounded p-button-text"
            [style]="{ 'color': '#2196F3' }">
          </p-button>

          <p-button
            icon="pi pi-pencil"
            [disabled]="!canOpenSign(order)"
            pTooltip="Abrir estado del flujo y firmar"
            tooltipPosition="top"
            (onClick)="openSignModal(order)"
            styleClass="p-button-rounded p-button-text"
            [style]="{ 'color': '#FFC107' }">
          </p-button>

          <p-button
            icon="pi pi-eye"
            [disabled]="!canView(order)"
            pTooltip="Ver el PDF generado"
            tooltipPosition="top"
            (onClick)="viewReport(order)"
            styleClass="p-button-rounded p-button-text"
            [style]="{ 'color': '#4CAF50' }">
          </p-button>

        </div>
      </td>

      </tr>
    </ng-template>

    <!-- EMPTY -->
    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="9">No se encontraron órdenes.</td>
      </tr>
    </ng-template>
  </p-table>
</div>

  <!-- MODAL DE CREACIÓN -->
  <p-dialog
    [(visible)]="showNewModal"
    [modal]="true"
    [draggable]="false"
    [resizable]="false"
    [style]="{ width: '60rem', maxWidth: '95vw' }"
    header="Nueva Orden de Combustible"
    (onHide)="closeNewModal()">

    <!-- Form embebido; emite (saved) y (cancel) -->
    <app-new-fuel-voucher
      (saved)="onCreated($event)"
      (cancel)="closeNewModal()">
    </app-new-fuel-voucher>
  </p-dialog>




  <!-- MODAL DE FIRMA -->
<p-dialog
  [(visible)]="showSignModal"
  [modal]="true"
  [draggable]="false"
  [resizable]="false"
  [style]="{ width: '44rem', maxWidth: '95vw' }"
  header="Firma del Vale de Combustible"
  (onHide)="showSignModal=false">

  @if (signing?.data; as info) {
    <div style="display: flex; flex-direction: column; gap: 1rem;">
      
      <div style="display: flex; align-items: center; gap: 1rem;">
        <p-tag 
          [value]="info.status" 
          [severity]="info.status==='in_progress' ? 'warning' : (info.status==='completed' ? 'success' : 'danger')">
        </p-tag>
        <span style="font-size: 0.875rem; color: #6b7280;">Páginas: {{ info.pdf_page_number }}</span>
      </div>

      <div style="padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;">
        <div style="font-size: 0.875rem; color: #4b5563;">Paso actual</div>
        <div style="font-weight: 500;">
          {{ currentStepRole }}
        </div>
      </div>

      <div style="padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px;">
        <div style="font-size: 0.875rem; color: #4b5563;">¿Puedo firmar?</div>
        <div style="font-weight: 500;">
          {{ info.can_sign ? 'Sí' : 'No' }}
        </div>
      </div>

      <div style="margin-top: 0.5rem;">
        <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.5rem;">Flujo de firmas</div>
        <div style="display: grid; gap: 0.5rem;">
          @for (s of info.flow?.steps; track s.order) {
            <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
              <div>
                <div style="font-weight: 500;">{{ s.role }}</div>
                <div style="font-size: 0.75rem; color: #6b7280;">Orden {{ s.order }}</div>
              </div>
              <p-tag
                [value]="s.status"
                [severity]="s.status==='signed' ? 'success' : (s.status==='rejected' ? 'danger' : 'warning')">
              </p-tag>
            </div>
          }
        </div>
      </div>

      <div style="display: flex; justify-content: flex-end; gap: 0.5rem; padding-top: 1rem;">
        <p-button
          label="Firmar ahora"
          icon="pi pi-check"
          [disabled]="!info.can_sign"
          (onClick)="signNow()">
        </p-button>
        <p-button
          label="Cerrar"
          severity="secondary"
          (onClick)="showSignModal=false">
        </p-button>
      </div>
    </div>
  } @else {
    <ng-container *ngTemplateOutlet="loadingSign"></ng-container>
  }

  <ng-template #loadingSign>
    <div style="padding: 2rem 0; text-align: center; color: #6b7280;">
      Cargando estado de firma…
    </div>
  </ng-template>
</p-dialog>

