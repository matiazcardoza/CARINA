<div class="card">
  <div>
    <h1 class="text-3xl font-semibold mb-2">Órdenes de Combustible</h1>
    <p class="text-lg text-gray-500">Lista y estado de aprobación de las órdenes de atención de combustible.</p>
  </div>
  
  <div class="flex justify-end mb-3">
    <p-button
      label="Nueva orden"
      icon="pi pi-plus"
      (onClick)="openNewModal()">
    </p-button>
  </div>


  <p-table
    #dt1
    [value]="orders()"
    [paginator]="true"
    [rows]="pageSize"
    [totalRecords]="ordersTotal()"
    [lazy]="true"
    (onLazyLoad)="onOrdersLazyLoad($event)"

    [globalFilterFields]="['numero','fecha','vehiculo_placa','fuel_type','quantity_gal','amount_soles','supervisor_status','manager_status']"
    selectionMode="single"
    [(selection)]="selectedOrder"
    dataKey="id"

    stateStorage="session"
    stateKey="fuelorders-session"
    [scrollable]="true"
    scrollDirection="both"
    [tableStyle]="{ 'min-width': '70rem' }"
    [loading]="loadingOrders()"
  >
    <!-- CAPTION (filtros) -->
    <ng-template pTemplate="caption">
      <div
        style="
          display:grid;
          grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
          gap:12px;
          align-items:end;
          grid-auto-flow:dense;
          width:100%;
        "
      >
        <!-- N° Orden -->
        <p-iconfield style="display:block; width:100%;">
          <p-inputicon><i class="pi pi-search"></i></p-inputicon>
          <input
            pInputText
            type="text"
            name="numero"                        
            [(ngModel)]="uiFilters.numero"
            placeholder="N° Orden"
            style="width:100%;"
          />
        </p-iconfield>

        <!-- Placa -->
        <div style="width:100%;">
          <input
            pInputText
            type="text"
            name="placa"                         
            [(ngModel)]="uiFilters.placa"
            placeholder="Placa"
            style="width:100%;"
          />
        </div>

        <!-- Ver todo -->
        <div class="flex items-center gap-2" style="width:100%;">
          <p-checkbox
            inputId="all"
            name="all"                             
            [(ngModel)]="uiFilters.all"
            binary="true"
            label="Ver todo">
          </p-checkbox>
        </div>


        <!-- Botones -->
        <div style="grid-column:1 / -1; display:flex; gap:8px; justify-content:flex-end; margin-top:4px;">
          <p-button label="Buscar" icon="pi pi-search" (onClick)="onSearchClick()"></p-button>
          <p-button label="Limpiar" severity="secondary" outlined (onClick)="onClearClick()"></p-button>
        </div>
      </div>
    </ng-template>

    <!-- HEADER -->
    <ng-template pTemplate="header">
      <tr>
        <th style="width:8%"><div class="item_head">N° Orden</div></th>
        <th style="width:9%"><div class="item_head">Fecha</div></th>
        <th style="width:10%"><div class="item_head">Placa</div></th>
        <th style="width:10%"><div class="item_head">Combustible</div></th>
        <th style="width:8%"><div class="item_head">Glns</div></th>
        <th style="width:10%"><div class="item_head">Importe (S/)</div></th>
        <th style="width:12%"><div class="item_head">Supervisor</div></th>
        <th style="width:12%"><div class="item_head">Jefe</div></th>
        <th pFrozenColumn alignFrozen="right" [style]="{ width: '160px', textAlign: 'center' }">
          <span class="flex items-center gap-2">
            Acciones
            <i class="pi pi-cog text-gray-500"></i>
          </span>
        </th>
      </tr>
    </ng-template>

    <!-- BODY -->
    <ng-template pTemplate="body" let-order>
      <tr>
        <td>{{ order.numero || '—' }}</td>
        <td>{{ order.fecha | date:'dd/MM/yyyy' }}</td>
        <td>{{ order.vehiculo_placa || order.vehicle?.plate }}</td>
        <td class="text-capitalize">{{ order.fuel_type }}</td>
        <td>{{ order.quantity_gal }}</td>
        <td>{{ order.amount_soles }}</td>

        <td>
          <p-tag
            [value]="(order.supervisor_status ?? 'pendiente')"
            [severity]="order.supervisor_status === 'approved' ? 'success' :
                        order.supervisor_status === 'rejected' ? 'danger' : 'warning'">
          </p-tag>
        </td>
        <td>
          <p-tag
            [value]="(order.manager_status ?? 'pendiente')"
            [severity]="order.manager_status === 'approved' ? 'success' :
                        order.manager_status === 'rejected' ? 'danger' : 'warning'">
          </p-tag>
        </td>

        <!-- Acciones -->
        <td pFrozenColumn alignFrozen="right">
          <div class="flex container_action_buttons gap-2">
            <p-button
              icon="pi pi-eye"
              severity="info"
              pTooltip="Ver detalle"
              (onClick)="openOrderDetails(order)">
            </p-button>

            <!-- Botón aprobar (visible según rol y estado) -->
            <!-- *ngIf="canApprove(order)" -->
            <p-button
              icon="pi pi-check"
              severity="success"
              pTooltip="Aprobar">
            </p-button>
            <!-- (onClick)="onDecision(order, 'approved')"> -->

            <!-- Botón rechazar (visible según rol y estado) -->
            <!-- *ngIf="canApprove(order)" -->
            <p-button
              icon="pi pi-times"
              severity="danger"
              pTooltip="Rechazar"
              >
            </p-button>
            <!-- (onClick)="onDecision(order, 'rejected')" -->
          </div>
        </td>
      </tr>
    </ng-template>

    <!-- EMPTY -->
    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="9">No se encontraron órdenes.</td>
      </tr>
    </ng-template>
  </p-table>
</div>

  <!-- MODAL DE CREACIÓN -->
  <p-dialog
    [(visible)]="showNewModal"
    [modal]="true"
    [draggable]="false"
    [resizable]="false"
    [style]="{ width: '60rem', maxWidth: '95vw' }"
    header="Nueva Orden de Combustible"
    (onHide)="closeNewModal()">

    <!-- Form embebido; emite (saved) y (cancel) -->
    <app-new-fuel-voucher
      (saved)="onCreated($event)"
      (cancel)="closeNewModal()">
    </app-new-fuel-voucher>
  </p-dialog>
