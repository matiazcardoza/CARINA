<div class="card">
  <div>
    <h1 class="text-3xl font-semibold mb-2">Gestión del Kardex</h1>
    <p class="text-lg text-gray-500">Aquí se muestran los productos relacionados a las órdenes de compra.</p>
  </div>

  <p-table
    #dt1
    [value]="pecosas()"
    [paginator]="true"
    [rows]="pageSize"
    [totalRecords]="productsTotal()"
    [lazy]="false"
    (onLazyLoad)="onProductsLazyLoad($event)"

    [globalFilterFields]="['numero','fecha','detalles_orden','rsocial','ruc','item','detalle','cantidad','desmedida','precio','total_internado','saldo']"
    selectionMode="single"
    [(selection)]="selectedProduct"
    dataKey="idcompradet"


    stateStorage="session"
    stateKey="statedemo-session"
    [scrollable]="true"
    scrollDirection="both"
    [tableStyle]="{ 'min-width': '100rem' }"
    [loading]="loadingPecosas()"
  
  >
  <!-- scrollHeight="flex"  -->
    <!-- Caption -->

     <!-- BUSQUEDA -->
    <!-- <ng-template pTemplate="caption">
      <p-iconfield iconPosition="left">
        <p-inputicon><i class="pi pi-search"></i></p-inputicon>
        <input
          pInputText
          type="text"
          [value]="filterProducts()"
          (input)="getProductsOfSiluciaBackend({numero: $event.target?.value})"
          placeholder="Global Search"
        />
      </p-iconfield>
    </ng-template> -->

    <ng-template pTemplate="caption">
      <div
        style="
          display:grid;
          grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
          gap:12px;
          align-items:end;
          grid-auto-flow:dense;
          width:100%;
        "
      >
        <!-- N° Orden -->
        <p-iconfield style="display:block; width:100%;">
          <p-inputicon><i class="pi pi-search"></i></p-inputicon>
          <input pInputText type="text" [(ngModel)]="uiFilters.numero" placeholder="N° de Pecosa" style="width:100%;" />
        </p-iconfield>

        <!-- Año -->
        <div style="width:100%;">
          <input pInputText type="number" [(ngModel)]="uiFilters.anio" placeholder="Año" style="width:100%;" />
        </div>

        <!-- SIAF -->
        <!-- <div style="width:100%;">
          <input pInputText type="text" [(ngModel)]="uiFilters.siaf" placeholder="SIAF" style="width:100%;" />
        </div> -->

        <!-- RUC -->
        <!-- <div style="width:100%;">
          <input pInputText type="text" [(ngModel)]="uiFilters.ruc" placeholder="RUC" style="width:100%;" />
        </div> -->

        <!-- Razón social -->
        <!-- <div style="width:100%;">
          <input pInputText type="text" [(ngModel)]="uiFilters.rsocial" placeholder="Razón social" style="width:100%;" />
        </div> -->

        <!-- Ítem -->
        <div style="width:100%;">
          <input pInputText type="text" [(ngModel)]="uiFilters.item" placeholder="Ítem" style="width:100%;" disabled/>
        </div>

        <!-- Meta -->
        <div style="width:100%;">
          <input pInputText type="text" [(ngModel)]="uiFilters.desmeta" placeholder="Meta (desmeta)" style="width:100%;" disabled/>
        </div>

        <!-- Email -->
        <!-- <div style="width:100%;">
          <input pInputText type="text" [(ngModel)]="uiFilters.email" placeholder="Email proveedor" style="width:100%;" />
        </div> -->

        <!-- Botones (fila completa, alineados a la derecha) -->
        <div style="grid-column:1 / -1; display:flex; gap:8px; justify-content:flex-end; margin-top:4px;">
          <p-button label="Buscar" icon="pi pi-search" (onClick)="onSearchClick()"></p-button>
          <p-button label="Limpiar" severity="secondary" outlined (onClick)="onClearClick()"></p-button>
        </div>
      </div>
    </ng-template>


    <!-- Header -->
    <ng-template pTemplate="header">
      <tr>
        <!-- pSortableColumn="numero"  -->
        <th style=""> <div class="item_head">Año <!-- <p-sortIcon field="numero"/> -->  </div> </th>
        <th style="min-width: 7rem;"> <div class="item_head">Fecha <!-- <p-sortIcon field="numero"/> -->  </div> </th>
        <th style="min-width: 8rem;"> <div class="item_head">N° de Pecosa <!-- <p-sortIcon field="numero"/> -->  </div> </th>
        <th style="min-width: 7rem;"> <div class="item_head">N° de Item <!-- <p-sortIcon field="numero"/> -->  </div> </th>
        <th style=""> <div class="item_head">Cantidad <!-- <p-sortIcon field="numero"/> -->  </div> </th>
        <th style=""> <div class="item_head">Precio <!-- <p-sortIcon field="numero"/> -->  </div> </th>
        <th style=""> <div class="item_head">Medidad <!-- <p-sortIcon field="numero"/> -->  </div> </th>
        <th style=""> <div class="item_head">Item <!-- <p-sortIcon field="numero"/> -->  </div> </th>
        <th style=""> <div class="item_head">prod_proy <!-- <p-sortIcon field="numero"/> -->  </div> </th>
        <th style="min-width: 7rem;"> <div class="item_head">N° de Meta <!-- <p-sortIcon field="numero"/> -->  </div> </th>
        <th style=""> <div class="item_head">Meta <!-- <p-sortIcon field="numero"/> -->  </div> </th>
        <th style=""> <div class="item_head">desuoper <!-- <p-sortIcon field="numero"/> -->  </div> </th>
        <th style=""> <div class="item_head">destipodestino <!-- <p-sortIcon field="numero"/> -->  </div> </th>

        <th pFrozenColumn alignFrozen="right" [style]="{ width: '150px', textAlign: 'center' }">
            <span class="flex items-center gap-2">
                Acciones
                <i class="pi pi-cog text-gray-500"></i>
            </span>
        </th>
     </tr>
    </ng-template>

    <!-- Body -->
    <ng-template pTemplate="body" let-pecosa>
      <tr>
        <td>{{ pecosa.anio }}</td>
        <td>{{ pecosa.fecha }}</td>
        <td>{{ pecosa.numero }}</td>
        <td>{{ pecosa.idsalidadet }}</td>
        <td>{{ pecosa.cantidad }}</td>
        <td>{{ pecosa.precio }}</td>
        <td>{{ pecosa.desmedida }}</td>
        <td style="padding:0; min-width: 12rem;">
          <div style="max-height:120px;overflow:auto;line-height:1.35;padding:6px 8px;text-align:justify;word-break:break-word;">
          {{ pecosa.item}}
          </div>
        </td>
        <td>{{ pecosa.prod_proy }}</td>
        <td>{{ pecosa.cod_meta }}</td>
        <td>{{ pecosa.desmeta }}</td>
        <td>{{ pecosa.desuoper }}</td>
        
        <td>{{ pecosa.destipodestino }}</td>

        <!-- Celda congelada a la derecha -->
        <td pFrozenColumn alignFrozen="right">
          <div class="flex container_action_buttons gap-2">
              <!-- label="Ver" -->
            <p-button
              icon="pi pi-eye"
              severity="info"
              (onClick)="openMovementDetailsModal(pecosa)">
            </p-button>
            <!-- label="Agregar" -->
            <p-button
              icon="pi pi-plus"
              severity="success"
              (onClick)="openMovementModal(pecosa)">
            </p-button>
          </div>
        </td>
      </tr>
    </ng-template>

    <!-- Empty -->
    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="13">No se encontraron registros.</td>
      </tr>
    </ng-template>
  </p-table>
</div>


<!-- ------------------Modal para registrar movimientos-------------------------------- -->

<p-dialog
  header="Registrar movimiento"
  [(visible)]="showMovementModal"
  [modal]="true"
  [closable]="true"
  [style]="{ width: '450px' }"
>
  <div class="p-fluid container_dialog">

    <!-- Tipo de movimiento -->
    <div class="field dialog_item">
      <!-- <label class="">Tipo de movimiento</label> -->
      <span  style="display: block; font-weight: bold; margin-bottom: 0.5rem;">Tipo de movimiento</span>
      <div style="display: flex;">
          <div style="flex-grow: 1; display: flex; gap: 0.5rem; align-items: center;">
              <p-radiobutton 
                [inputId]="'movEntrada'"
                name="movement_type"
                [value]="'entrada'"
                [(ngModel)]="form.movement_type" 
              />
              <label for="category1">Entrada</label>
          </div>
          <div style="flex-grow: 1; display: flex; gap: 0.5rem; align-items: center; align-content: center;">
              <p-radiobutton 
                [inputId]="'movSalida'"
                name="movement_type"
                [value]="'salida'"
                [(ngModel)]="form.movement_type"
              />
              <label for="category2">Salida</label>
          </div>
      </div>
    </div>

    <!-- Cantidad -->
    <div class="field dialog_item">
      <label for="cantidad" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">Cantidad</label>
      <p-inputNumber
        inputId="cantidad"
        [(ngModel)]="form.amount"
        [min]="1"
        [useGrouping]="false"
        [showButtons]="true"
      ></p-inputNumber>
    </div>

    <!-- Comentario -->
    <div class="field dialog_item">
      <label for="observations" style="display: block; font-weight: bold; margin-bottom: 0.5rem;">Observaciones</label>
      <textarea
        id="observations"
        pInputTextarea
        [(ngModel)]="form.observations"
        rows="3"
        cols="30"
        placeholder="Escribe tus observaciones aquí"
        class="text-area"
        ></textarea>
        <!-- style="resize: vertical; border: 1px solid rgb(178, 191, 194); border-radius: 8px; font-family: 'Courier New', Courier, monospace; font-size: 1.2rem;" -->
    </div>


    <!-- Personas -->
    <div class="field dialog_people">
      <div class="flex items-center justify-between dialog_people_item">
        <span class="font-medium">Personas</span>
        <p-button
          icon="pi pi-user-plus"
          (onClick)="OpenModalAddPerson()"
          [rounded]="true"
          [text]="true"
          [ariaLabel]="'Adicionar persona'"
        ></p-button>
      </div>
      <!-- Aquí podrías listar las personas seleccionadas si lo necesitas -->
      <!-- <small class="text-gray-500">Añade personas con el botón.</small> -->
    </div>
    <!-- <button (click)="seeDataSelected()">see data selected</button> -->

  @if (listDniPeople().length > 0) {
    <p-listbox [options]="listDniPeople()" [style]="{ width: '100%' }" [filter]="false">
      <ng-template let-item pTemplate="item">
        <div style="display: flex; flex-direction: column; gap: 0.25rem;">
          <span><strong>DNI:</strong> {{ item.dni }}</span>
          <span><strong>Nombre:</strong> {{ item.names }}</span>
          <span><strong>Apellido paterno:</strong> {{ item.first_lastname }}</span>
          <span><strong>Apellido materno:</strong> {{ item.second_lastname }}</span>
        </div>
      </ng-template>
    </p-listbox>
  }

  </div>

  <ng-template pTemplate="footer">
    <div style="display: flex; justify-content: flex-end; gap: 0.5rem; width: 100%;">
      <p-button
        label="Cancelar"
        severity="secondary"
        outlined
        (onClick)="closeMovementModal()"
      ></p-button>
      <p-button
        label="Aceptar"
        icon="pi pi-check"
        (onClick)="onSubmitMovement()"
        [disabled]="!form.movement_type || !form.amount"
        [loading]="savingMovementLoading()"
      ></p-button>
    </div>
  </ng-template>
</p-dialog>


<!-- ------------------ Modal para mostrar movimientos-------------------- -->

<p-dialog 
  header="Detalles de movimientos"
  [(visible)]="showMovementDetailsModal"
  [modal]="true"
  [closable]="false"
  >
  
  <!-- [style]="{ minWidth: 'px'}" -->
  <!-- <div class="p-fluid flex flex-col gap-3"> -->
  <div 
    style="
      /* background: pink;
      border: 3px solid orange;
      width: 500px;
      height: 600px; */
      overflow: hidden;"
    >
    <p-table
      [value]="movementsKardex()"
      [paginator]="true"
      [rows]="movementsPageSize"
      [totalRecords]="movementsTotal()"
      [lazy]="true"
      (onLazyLoad)="onMovementsLazyLoad($event)"
      [loading]="movementsLoading()"
      dataKey="id"
    
      [expandedRowKeys]="expandedRowsMovements()"
      (onRowExpand)="onRowExpandMovement($event)"
      (onRowCollapse)="onRowCollapseMovement($event)"
    >
      <!-- [expandedRowKeys]="expandedRowsMovements" -->

        <!-- RESUMEN ARRIBA -->
      <ng-template pTemplate="caption">
        <div
          style="
            display:flex;
            flex-wrap:wrap;
            align-items:center;
            gap:18px;
            padding:12px 14px;
            background:#fafafa;
            border:1px solid #e5e7eb;
            border-radius:10px;
            box-shadow:0 1px 2px rgba(0,0,0,0.04);
          "
        >
          <span
            style="
              display:flex;
              align-items:center;
              gap:8px;
              font-size:1.1rem;          /* texto un poquito más grande */
              font-weight:600;
              color:#14532d;
            "
          >
            <i class="pi pi-sign-in" style="font-size:1.25rem; color:#16a34a;"></i>
            <span>
              Total entradas:
              <span style="font-weight:700;">{{ totalEntradas }}</span>
            </span>
          </span>

          <span
            style="
              display:flex;
              align-items:center;
              gap:8px;
              font-size:1.1rem;
              font-weight:600;
              color:#7f1d1d;
            "
          >
            <i class="pi pi-sign-out" style="font-size:1.25rem; color:#dc2626;"></i>
            <span>
              Total salidas:
              <span style="font-weight:700;">{{ totalSalidas }}</span>
            </span>
          </span>

          <span
            style="
              display:flex;
              align-items:center;
              gap:8px;
              font-size:1.1rem;
              font-weight:600;
              color:#0b4191;
            "
          >
            <i class="pi pi-box" style="font-size:1.25rem; color:#0284c7;"></i>
            <span>
              Stock:
              <span style="font-weight:700;">{{ stockSaldo }}</span>
            </span>
          </span>
        </div>
      </ng-template>
      <!-- [tableStyle]="{ 'min-width': '60rem' }" -->
      <!-- [tableStyle]="{ 'min-width': '60rem' }" -->
      <ng-template pTemplate="header">
        <tr>
          <th style="width:3rem;"></th> <!-- nueva -->
          <th pSortableColumn="id">ID <p-sortIcon field="id"/></th>
          <th pSortableColumn="movement_type">Tipo <p-sortIcon field="movement_type"/></th>
          <th pSortableColumn="amount">Cantidad <p-sortIcon field="amount"/></th>
          <!-- <th pSortableColumn="amount">Unidad Medida <p-sortIcon field="amount"/></th> -->
          <th pSortableColumn="amount" style="max-width: 200px; width:200px;">Observaciones <p-sortIcon field="amount"/></th>
          <th pSortableColumn="movement_date">Fecha <p-sortIcon field="movement_date"/></th>
          <!-- <th pSortableColumn="final_balance">Saldo final <p-sortIcon field="final_balance"/></th> -->
        </tr>
      </ng-template>

      <!-- <ng-template pTemplate="body" let-movement>
        <tr>
          <td>{{ movement.id }}</td>
          <td>{{ movement.movement_type }}</td>
          <td>{{ movement.amount }}</td>
          <td style=" text-align: justify;" >{{ movement.observations || 'ninguna' }}</td>
          <td>{{ movement.movement_date }}</td>
        </tr>
      </ng-template> -->

      <ng-template pTemplate="body" let-movement let-expanded="expanded">
        <tr>    
          <td>
            <p-button type="button"
              [pRowToggler]="movement"
              [disabled]="!movement?.people?.length"
              [text]="true"
              [rounded]="true"
              severity="secondary"
              [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'">
            </p-button>
          </td>
          <td>{{ movement.id }}</td>
          <td>{{ movement.movement_type }}</td>
          <td>{{ movement.amount }}</td>

          <!-- Observaciones con scroll interno -->
          <td style="max-width:300px; width:300px; padding:0;">
            <div
              style="
                max-height:84px;            /* ~4–5 líneas aprox */
                overflow-y:auto;            /* muestra scroll vertical si excede */
                overflow-x:hidden;          /* evita scroll horizontal */
                line-height:1.35;
                text-align:justify;
                padding:6px 8px;            /* algo de aire */
                word-break:break-word;      /* corta palabras largas */
                white-space:normal;         /* asegura múltiples líneas */
              "
            >
              {{ movement.observations || 'ninguna' }}
            </div>
          </td>

          <td>{{ movement.movement_date }}</td>
        </tr>
      </ng-template>

      <!-- <ng-template pTemplate="footer">
        <tr>
          <td colspan="5">
            <div class="flex justify-end gap-6" style="display:flex; justify-content:flex-start; gap:1.5rem;">
              <span><strong>Total entradas:</strong> {{ totalEntradas }}</span>
              <span><strong>Total salidas:</strong> {{ totalSalidas }}</span>
              <span><strong>Stock (entradas - salidas):</strong> {{ stockSaldo }}</span>
            </div>
          </td>
        </tr>
      </ng-template> -->

      <!-- <ng-template pTemplate="rowexpansion" let-movement> -->
      <ng-template pTemplate="expandedrow" let-movement>
        <tr>
          <td colspan="6">
            <div style="padding:10px 8px;background:#f9fafb;border:1px solid #e5e7eb;border-radius:8px;">
              <h4 style="margin:0 0 8px 0;font-size:1rem;">Personas anexadas</h4>

              <p-table [value]="movement.people || []">
                <ng-template pTemplate="header">
                  <tr>
                    <th style="width:8rem;">DNI</th>
                    <th>Nombre completo</th>
                    <!-- <th style="width:8rem;">Rol</th> -->
                    <!-- <th>Nota</th> -->
                    <th style="width:11rem;">Adjuntado</th>
                  </tr>
                </ng-template>

                <ng-template pTemplate="body" let-person>
                  <tr>
                    <td>{{ person.dni }}</td>
                    
                    <td>{{ person.full_name + ' ' + (person.first_lastname || '')  + ' ' +(person.second_lastname || '')    }}</td>
                    <!-- <td>{{ person.pivot?.role || '—' }}</td> -->
                    <!-- <td>{{ person.pivot?.note || '—' }}</td> -->
                    <td>{{ person.pivot?.attached_at || '—' }}</td>
                  </tr>
                </ng-template>

                <ng-template pTemplate="emptymessage">
                  <tr><td colspan="5">Sin personas anexadas.</td></tr>
                </ng-template>
              </p-table>
            </div>
          </td>
        </tr>
      </ng-template>


      <!-- <ng-template pTemplate="emptymessage">
        <tr><td colspan="5">Sin movimientos.</td></tr>
      </ng-template> -->
      <ng-template pTemplate="emptymessage">
        <tr><td colspan="6">Sin movimientos.</td></tr>
      </ng-template>
    </p-table>
    
  </div>

  <ng-template pTemplate="footer">
    <!-- <div class="flex justify-end gap-2 w-full"> -->
      <div style="display: flex; justify-content: flex-end; gap: 0.5rem; width: 100%;">
      <p-button label="Cerrar" severity="secondary" outlined (onClick)="closeMovementDetailsModal()"></p-button>
      <p-button label="Generar informe (pdf)" icon="pi pi-download" (onClick)="onSubmitMovementDetails()"></p-button>
    </div>
  </ng-template>
</p-dialog>

<!-- ------------------ Modal para adicionar personas por dni-------------------- -->
<app-add-new-user-modal
  [isOpen]="showAddUserModal"
  (sentOpenValue)="closeModalAddPerson()"
  (onListPeopleByDni)="handleListPeopleByDni($event)"
/>

<p-toast />