<div class="valorized-container">
  <!-- Header -->
  <div class="valorized-header">
    <div class="header-content">
      <h1>CUADRO DE RESUMEN MENSUAL - VALORIZACIÓN</h1>
      <p class="header-subtitle">Reporte de Horas de Maquinarias</p>
    </div>
    <button mat-raised-button color="success" (click)="saveValoration()">
      <mat-icon>save</mat-icon>
      Guardar Valorización
    </button>
    <button mat-icon-button class="close-button" (click)="closeDialog()">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <!-- Main Content -->
  <div class="valorized-content">

    <!-- Tabla de Valorización -->
    <div class="table-wrapper">
      <table class="valorization-table">
        <thead>
          <tr>
            <th>ITEM</th>
            <th>MAQUINARIA</th>
            <th>OPERARIO</th>
            <th>MARCA</th>
            <th>PLACA</th>
            <th>HORAS TRABAJADAS POR MÁQUINA</th>
            <th>PRECIO HORA MÁQUINA</th>
            <th>TOTAL EN SOLES</th>
            <th>COSTO POR DÍA</th>
            <th>DÍAS TRABAJADOS</th>
            <th>ACCIONES</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let machinery of valorationData.machinery; let i = index" [class.deleted-row]="deletedRows.has(i)">
            <td class="text-center">{{ i + 1 }}</td>
            <td>{{ getMachineryName(machinery.equipment) }}</td>
            <td>
              <input type="text" class="editable-input editable-operator" [(ngModel)]="editedOperators[i]">
            </td>
            <td>{{ getBrand(machinery.equipment) }}</td>
            <td>{{ getPlate(machinery.equipment) }}</td>
            <td class="text-center">{{ machinery.equivalent_hours | number:'1.2-2'}}</td>
            <td class="text-right">{{ machinery.cost_per_hour | number:'1.2-2' }}</td>
            <td class="text-right highlight">S/. {{ machinery.total_amount | number:'1.2-2' }}</td>
            <td class="text-right">S/. {{ machinery.cost_per_day | number:'1.2-2' }}</td>
            <td class="text-center">{{ machinery.days_worked }}</td>
            <td class="text-center">
              <button
                mat-icon-button
                color="warn"
                (click)="deleteRow(i)"
                [disabled]="deletedRows.has(i)"
                class="delete-btn">
                <mat-icon>delete</mat-icon>
              </button>
            </td>
          </tr>

          <!-- Fila de Totales -->
          <tr class="total-row">
            <td colspan="7" class="text-right"><strong>TOTAL</strong></td>
            <td class="text-right total-amount">
              <strong>S/. {{ valorationData.valoration_amount | number:'1.2-2' }}</strong>
            </td>
            <td colspan="2"></td>
          </tr>

          <!-- NUEVO: INPUT DE PLANILLA -->
          <tr class="planilla-row">
            <td colspan="7" class="text-right"><strong>MONTO PLANILLA</strong></td>
            <td class="text-right">
              <input
                type="number"
                min="0"
                step="0.01"
                class="editable-input planilla-input"
                [(ngModel)]="amountPlanilla"
                (input)="onAmountPlanillaChange()">
            </td>
            <td colspan="2"></td>
          </tr>

        </tbody>
      </table>
    </div>

    <!-- Resumen -->
    <div class="summary-section">
      <div class="summary-card">
        <h3>RESUMEN</h3>

        <div class="summary-item-large">
          <span class="summary-label">MONTO TOTAL DE VALORIZACIÓN (FINAL):</span>
          <span class="summary-value">
            S/.
            <input
              type="number"
              class="editable-input editable-total"
              [value]="editedValorationAmount"
              readonly>
          </span>
        </div>

        <div class="summary-note">
          <p>Pago a operadores de maquinaria pesada del GRP, según Planilla</p>
        </div>
      </div>
    </div>

  </div>

  <!-- Footer -->
  <div class="valorized-footer">
    <button mat-raised-button color="warn" (click)="closeDialog()">
      <mat-icon>close</mat-icon>
      Cerrar
    </button>
    <button mat-raised-button color="primary" (click)="generateValorization()">
      <mat-icon>picture_as_pdf</mat-icon>
      Generar Valorización
    </button>
  </div>

</div>
