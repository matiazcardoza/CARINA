<div class="valorized-container">
  <!-- Header -->
  <div class="valorized-header">
    <div class="header-content">
      <h1>CUADRO DE RESUMEN MENSUAL - VALORIZACI√ìN</h1>
      <p class="header-subtitle">Reporte de Horas de Maquinarias</p>
    </div>
    
    <div class="header-actions">
      <div class="version-selector">
        <label for="versionSelect">Versi√≥n:</label>
        <select 
          id="versionSelect" 
          [(ngModel)]="selectedAdjustmentId" 
          (change)="onVersionChange()"
          [disabled]="isHistoryLoading">
          <option [ngValue]="null">Actual</option>
          <option 
            *ngFor="let adjustment of adjustmentHistory" 
            [ngValue]="adjustment.id">
            {{ adjustment.created_at | date:'dd/MM/yyyy' }}
          </option>
        </select>
      </div>
      
      <button 
        class="btn btn-success" 
        (click)="saveValoration()"
        [disabled]="isLoading"
        title="Guardar valorizaci√≥n en base de datos">
        üíæ Guardar Valorizaci√≥n
        <span *ngIf="hasUnsavedChanges" class="badge-warning">‚óè</span>
      </button>
      
      <button
        class="btn btn-info"
        [matMenuTriggerFor]="deductivesMenu"
        [disabled]="isLoading">
        ‚ûï Agregar Deductivos
      </button>

      <mat-menu #deductivesMenu="matMenu">
        <button mat-menu-item (click)="openDeductivesDialog(true)">
          üì¶ Deductivo por Orden
        </button>
        <button mat-menu-item (click)="openDeductivesDialog(false)">
          üìÑ Deductivo por Planilla
        </button>
      </mat-menu>

    </div>
  </div>

  <!-- Main Content -->
  <div class="valorized-content">

    <!-- Tabla de Valorizaci√≥n -->
    <div class="table-wrapper">
      <table class="valorization-table">
        <thead>
          <tr>
            <th>ITEM</th>
            <th>MAQUINARIA</th>
            <th>OPERARIO</th>
            <th>MARCA</th>
            <th>PLACA</th>
            <th>HORAS TRABAJADAS POR M√ÅQUINA</th>
            <th>PRECIO HORA M√ÅQUINA</th>
            <th>TOTAL EN SOLES</th>
            <th>COSTO POR D√çA</th>
            <th>D√çAS TRABAJADOS</th>
            <th>ACCIONES</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let machinery of machinery; let i = index" [class.deleted-row]="deletedRows.has(i)">
            <td class="text-center">{{ i + 1 }}</td>
            <td>{{ getMachineryName(machinery.equipment) }}</td>
            <td>
              <input type="text" class="editable-input editable-operator" [(ngModel)]="editedOperators[i]">
            </td>
            <td>{{ getBrand(machinery.equipment) }}</td>
            <td>{{ getPlate(machinery.equipment) }}</td>
            <td class="text-center">{{ machinery.equivalent_hours | number:'1.2-2'}}</td>
            <td class="text-right">{{ machinery.cost_per_hour | number:'1.2-2' }}</td>
            <td class="text-right highlight">S/. {{ machinery.total_amount | number:'1.2-2' }}</td>
            <td class="text-right">S/. {{ machinery.cost_per_day | number:'1.2-2' }}</td>
            <td class="text-center">{{ machinery.days_worked }}</td>
            <td class="text-center">
              <button
                mat-icon-button
                color="warn"
                (click)="deleteRow(i)"
                [disabled]="deletedRows.has(i)"
                class="delete-btn">
                <mat-icon>delete</mat-icon>
              </button>
            </td>
          </tr>

          <!-- Fila de Totales -->
          <tr class="total-row">
            <td colspan="7" class="text-right"><strong>TOTAL</strong></td>
            <td class="text-right total-amount">
              <strong>S/. {{ valorationAmount | number:'1.2-2' }}</strong>
            </td>
            <td colspan="2"></td>
          </tr>

          <!-- NUEVO: INPUT DE PLANILLA -->
          <tr class="planilla-row">
            <td colspan="7" class="text-right"><strong>MONTO PLANILLA</strong></td>
            <td class="text-right">
              <input
                type="number"
                min="0"
                step="0.01"
                class="editable-input planilla-input"
                [(ngModel)]="amountPlanilla"
                (input)="onAmountPlanillaChange()">
            </td>
            <td colspan="2"></td>
          </tr>

        </tbody>
      </table>
    </div>

    <!-- Resumen -->
    <div class="summary-section">
      <div class="summary-card">
        <h3>RESUMEN</h3>

        <div class="summary-item-large">
          <span class="summary-label">MONTO TOTAL DE VALORIZACI√ìN (FINAL):</span>
          <span class="summary-value">
            S/.
            <input
              type="number"
              class="editable-input editable-total"
              [value]="editedValorationAmount"
              readonly>
          </span>
        </div>

        <div class="summary-note">
          <p>Pago a operadores de maquinaria pesada del GRP, seg√∫n Planilla</p>
        </div>
      </div>
    </div>

  </div>

  <!-- Footer -->
  <div class="valorized-footer">
    <span *ngIf="goalData" class="footer-info">
      {{ goalData.goal_detail }}
    </span>
    <button 
      class="btn btn-danger" 
      (click)="closeDialog()">
      ‚úï Cerrar
    </button>
    <button 
      class="btn btn-primary" 
      (click)="generateValorization()"
      [disabled]="!valorationSaved || hasUnsavedChanges"
      [title]="getGenerateButtonTooltip()">
      üìÑ Generar Valorizaci√≥n
    </button>
  </div>

</div>
