<div class="valorized-container">
  <!-- Header -->
  <div class="valorized-header">
    <div class="header-content">
      <h1>CUADRO DE RESUMEN MENSUAL - VALORIZACI√ìN</h1>
      <p class="header-subtitle">Reporte de Horas de Maquinarias</p>
    </div>
    
    <div class="header-actions">
      <div class="version-selector">
        <label for="versionSelect">Versi√≥n:</label>
        <select 
          id="versionSelect" 
          [(ngModel)]="selectedAdjustmentId" 
          (change)="onVersionChange()"
          [disabled]="isHistoryLoading">
          <option [ngValue]="null">Actual</option>
          <option 
            *ngFor="let adjustment of adjustmentHistory" 
            [ngValue]="adjustment.id">
            {{ adjustment.created_at | date:'dd/MM/yyyy' }}
          </option>
        </select>
      </div>
      
      <button 
        class="btn btn-success" 
        (click)="saveValoration()"
        [disabled]="isLoading"
        title="Guardar valorizaci√≥n en base de datos">
        üíæ Guardar Valorizaci√≥n
        <span *ngIf="hasUnsavedChanges" class="badge-warning">‚óè</span>
      </button>
      
      <button
        class="btn btn-info"
        [matMenuTriggerFor]="deductivesMenu"
        [disabled]="isLoading">
        <span *ngIf="deductivesOrder.length === 0 && deductivesSheet.length === 0">
          ‚ûï Agregar Deductivos
        </span>
        <span *ngIf="deductivesOrder.length > 0 || deductivesSheet.length > 0">
          ‚úèÔ∏è Editar Deductivos
          <span class="badge-info">{{ (deductivesOrder.length || 0) + (deductivesSheet.length || 0) }}</span>
        </span>
      </button>

      <mat-menu #deductivesMenu="matMenu">
        <button mat-menu-item (click)="openDeductivesDialog(true)">
          <span *ngIf="deductivesOrder.length === 0">üì¶ Agregar Deductivo por Orden</span>
          <span *ngIf="deductivesOrder.length > 0">‚úèÔ∏è Editar Deductivo por Orden ({{ deductivesOrder.length }})</span>
        </button>
        <button mat-menu-item (click)="openDeductivesDialog(false)">
          <span *ngIf="deductivesSheet.length === 0">üìÑ Agregar Deductivo por Planilla</span>
          <span *ngIf="deductivesSheet.length > 0">‚úèÔ∏è Editar Deductivo por Planilla ({{ deductivesSheet.length }})</span>
        </button>
      </mat-menu>

    </div>
  </div>

  <!-- Main Content -->
  <div class="valorized-content">

    <!-- Tabla de Valorizaci√≥n -->
    <div class="table-wrapper">
      <table class="valorization-table">
        <thead>
          <tr>
            <th>ITEM</th>
            <th>MAQUINARIA</th>
            <th>OPERARIO</th>
            <th>MARCA</th>
            <th>PLACA</th>
            <th>HORAS TRABAJADAS POR M√ÅQUINA</th>
            <th>PRECIO HORA M√ÅQUINA</th>
            <th>TOTAL EN SOLES</th>
            <th>COSTO POR D√çA</th>
            <th>D√çAS TRABAJADOS</th>
            <th>ACCIONES</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let machinery of machinery; let i = index" [class.deleted-row]="deletedRows.has(i)">
            <td class="text-center">{{ i + 1 }}</td>
            <td>{{ getMachineryName(machinery.equipment) }}</td>
            <td>
              <input type="text" class="editable-input editable-operator" [(ngModel)]="editedOperators[i]">
            </td>
            <td>{{ getBrand(machinery.equipment) }}</td>
            <td>{{ getPlate(machinery.equipment) }}</td>
            <td class="text-center">{{ machinery.equivalent_hours | number:'1.2-2'}}</td>
            <td class="text-right">{{ machinery.cost_per_hour | number:'1.2-2' }}</td>
            <td class="text-right highlight">S/. {{ machinery.total_amount | number:'1.2-2' }}</td>
            <td class="text-right">S/. {{ machinery.cost_per_day | number:'1.2-2' }}</td>
            <td class="text-center">{{ machinery.days_worked }}</td>
            <td class="text-center">
              <button
                mat-icon-button
                color="warn"
                (click)="deleteRow(i)"
                [disabled]="deletedRows.has(i)"
                class="delete-btn">
                <mat-icon>delete</mat-icon>
              </button>
            </td>
          </tr>

          <!-- Fila de Totales -->
          <tr class="total-row">
            <td colspan="7" class="text-right"><strong>TOTAL</strong></td>
            <td class="text-right total-amount">
              <strong>S/. {{ valorationAmount | number:'1.2-2' }}</strong>
            </td>
            <td colspan="2"></td>
          </tr>

          

        </tbody>
      </table>
    </div>

    <!-- Resumen -->
    <div class="summary-section">
      <div class="summary-card">
        <h3>RESUMEN</h3>

        <!-- Monto Total de Valorizaci√≥n -->
        <div class="summary-item">
          <span class="summary-label">MONTO TOTAL DE VALORIZACI√ìN:</span>
          <span class="summary-value-regular">
            S/. {{ valorationAmount | number:'1.2-2' }}
          </span>
        </div>

        <!-- Deductivo por Planilla (si existe) -->
        <ng-container *ngIf="getMonthlySheetSummary().length > 0">
          <div class="summary-item deductive-item" *ngFor="let monthData of getMonthlySheetSummary()">
            <span class="summary-label-deductive">
              Pago a operadores de maquinaria pesada del GRP, seg√∫n Planilla mes de {{ monthData.nombreMes }}
            </span>
            <span class="summary-value-deductive">
              S/. {{ monthData.total | number:'1.2-2' }}
            </span>
          </div>
        </ng-container>

        <!-- Deductivo por Orden (si existe) -->
        <div class="summary-item deductive-item" *ngIf="amountOrders > 0">
          <span class="summary-label-deductive">Pago por concepto de ordenes de COMPRA o SERVICIO</span>
          <span class="summary-value-deductive">
            S/. {{ amountOrders | number:'1.2-2' }}
          </span>
        </div>

        <!-- Total Final -->
        <div class="summary-item-large">
          <span class="summary-label">TOTAL A PAGAR:</span>
          <span class="summary-value">
            S/. {{ finalTotal | number:'1.2-2' }}
          </span>
        </div>
      </div>
    </div>

  </div>

  <!-- Footer -->
  <div class="valorized-footer">
    <span *ngIf="goalData" class="footer-info">
      {{ goalData.goal_detail }}
    </span>
    <button 
      class="btn btn-danger" 
      (click)="closeDialog()">
      ‚úï Cerrar
    </button>
    <button 
      class="btn btn-primary" 
      (click)="generateValorization()"
      [disabled]="!valorationSaved || hasUnsavedChanges"
      [title]="getGenerateButtonTooltip()">
      üìÑ Generar Valorizaci√≥n
    </button>
  </div>

</div>
