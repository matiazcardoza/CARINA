<div class="dashboard-container">
  
  <!-- Header del Dashboard -->
  <div class="dashboard-header">
    <h1>Reportes - Partes Diarios</h1>
    <button mat-raised-button color="primary"  (click)="descargarReporte()">
      <mat-icon>download</mat-icon>
      Descargar Reporte
    </button>
  </div>
      <mat-card class="header-card">
        <mat-card-header>
          <div mat-card-avatar class="header-avatar">
            <mat-icon>precision_manufacturing</mat-icon>
          </div>
          <mat-card-title>Reporte Detallado</mat-card-title>
          <mat-card-subtitle>Gestión de reporte de partes diarias</mat-card-subtitle>
        </mat-card-header>
        <form [formGroup]="searchForm">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Seleccionar Servicio</mat-label>
              <input 
              type="text"
              placeholder="Escriba para buscar o seleccione..."
              matInput
              formControlName="servicioSearch"
              [matAutocomplete]="auto">
              <mat-icon matSuffix>search</mat-icon>
              <button mat-icon-button matSuffix (click)="limpiarSelector()" 
                      matTooltip="Limpiar selección" 
                      type="button">
                <mat-icon>clear</mat-icon>
              </button>
                  
              <mat-autocomplete 
              #auto="matAutocomplete" 
              [displayWith]="displayServicio"
              (optionSelected)="onServicioSelected($event.option.value)">
                  
              <mat-option 
                  *ngFor="let servicio of filteredServicio| async" 
                  [value]="servicio"
                  class="servicio-option">
                      
                  <div class="option-content">
                    <div class="option-header">
                        <span>CODIGO META: </span><strong>{{servicio.goal_project || 'Sin Placa'}}</strong>
                    </div>
                    <div class="option-title">{{servicio.goal_detail}}</div>
                  </div>
              </mat-option>
                
              <mat-option *ngIf="(filteredServicio | async)?.length === 0" disabled>
                  <div class="no-results">
                  <mat-icon>search_off</mat-icon>
                  <span>No se encontraron equipos</span>
                  </div>
              </mat-option>
            </mat-autocomplete>
          </mat-form-field>
        </form>
      </mat-card>

      <!-- Mensaje de loading -->
      <div *ngIf="isLoading" class="loading-container">
        <mat-progress-bar mode="indeterminate"></mat-progress-bar>
        <p>Cargando datos...</p>
      </div>

      <!-- Mensaje de error -->
      <div *ngIf="errorMessage" class="error-container">
        <mat-icon color="warn">error</mat-icon>
        <p>{{ errorMessage }}</p>
      </div>

      <!-- Tabla de Partes Diarios -->
      <mat-card class="table-card" *ngIf="!isLoading && !errorMessage">
        <mat-card-header>
          <mat-card-title>Partes Diarios Registrados</mat-card-title>
          <mat-card-subtitle>{{ partesDiariosReales.length }} registros encontrados</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          
          <table mat-table [dataSource]="partesDiariosReales" class="parts-table">
            
            <!-- Columna Estado (reemplaza Fecha) -->
            <ng-container matColumnDef="estado">
              <th mat-header-cell *matHeaderCellDef>Estado</th>
              <td mat-cell *matCellDef="let parte">
                <mat-chip-set>
                  <mat-chip [color]="obtenerColorEstado(parte.state)" selected>
                    {{ obtenerTextoEstado(parte.state) }}
                  </mat-chip>
                </mat-chip-set>
              </td>
            </ng-container>

            <!-- Columna Servicio/Maquinaria -->
            <ng-container matColumnDef="servicio">
              <th mat-header-cell *matHeaderCellDef>Servicio/Maquinaria</th>
              <td mat-cell *matCellDef="let parte">
                <div class="service-info">
                  <strong>{{ parte.description }}</strong>
                  <div class="service-operator">
                    <mat-icon>person</mat-icon>
                    {{ parte.operator }}
                  </div>
                </div>
              </td>
            </ng-container>

            <!-- Columna Horas Trabajadas -->
            <ng-container matColumnDef="horasTrabajadas">
              <th mat-header-cell *matHeaderCellDef>Horas Trabajadas</th>
              <td mat-cell *matCellDef="let parte">
                <div class="hours-info">
                  <mat-icon>schedule</mat-icon>
                  {{ convertirTiempoAHoras(parte.total_time_worked) | number:'1.2-2' }}h
                </div>
                <div class="time-detail">
                  {{ parte.total_time_worked }}
                </div>
              </td>
            </ng-container>

            <!-- Columna Combustible Consumido -->
            <ng-container matColumnDef="combustibleConsumido">
              <th mat-header-cell *matHeaderCellDef>Combustible Consumido</th>
              <td mat-cell *matCellDef="let parte">
                <div class="fuel-info">
                  <mat-icon>local_gas_station</mat-icon>
                  {{ parte.fuel_consumed | number:'1.2-2' }}L
                </div>
              </td>
            </ng-container>

            <!-- Columna Estado Firmas (datos falsos temporales) -->
            <ng-container matColumnDef="estadoFirmas">
              <th mat-header-cell *matHeaderCellDef>Estado Firmas</th>
              <td mat-cell *matCellDef="let parte">
                <mat-chip-set>
                  <mat-chip [color]="obtenerColorEstadoFirmas(obtenerDatosFalsos(parte.id).estadoFirmas)" selected>
                    {{ obtenerEstadoFirmas(obtenerDatosFalsos(parte.id).estadoFirmas) }}
                  </mat-chip>
                </mat-chip-set>
                <div class="signatures-detail">
                  <mat-icon [class.signed]="obtenerDatosFalsos(parte.id).estadoFirmas.controlador">
                    {{ obtenerDatosFalsos(parte.id).estadoFirmas.controlador ? 'check_circle' : 'radio_button_unchecked' }}
                  </mat-icon>
                  <span>C</span>
                  <mat-icon [class.signed]="obtenerDatosFalsos(parte.id).estadoFirmas.residente">
                    {{ obtenerDatosFalsos(parte.id).estadoFirmas.residente ? 'check_circle' : 'radio_button_unchecked' }}
                  </mat-icon>
                  <span>R</span>
                  <mat-icon [class.signed]="obtenerDatosFalsos(parte.id).estadoFirmas.supervisor">
                    {{ obtenerDatosFalsos(parte.id).estadoFirmas.supervisor ? 'check_circle' : 'radio_button_unchecked' }}
                  </mat-icon>
                  <span>S</span>
                </div>
              </td>
            </ng-container>

            <!-- Columna Evidencias (datos falsos temporales) -->
            <ng-container matColumnDef="evidencias">
              <th mat-header-cell *matHeaderCellDef>Evidencias</th>
              <td mat-cell *matCellDef="let parte">
                <div class="evidence-info">
                  <button mat-icon-button color="primary" (click)="viewEvidenceData(parte.id, parte)">
                    <mat-icon>photo_camera</mat-icon>
                  </button>
                </div>
              </td>
            </ng-container>

            <!-- Columna Acciones -->
            <ng-container matColumnDef="acciones">
              <th mat-header-cell *matHeaderCellDef>Acciones</th>
              <td mat-cell *matCellDef="let parte">
                <div class="actions-container">
                  @if(parte.state_closure == 1){
                    <button mat-icon-button 
                            color="primary" 
                            (click)="liquidarServicio(parte.id, parte)"
                            matTooltip="Liquidar Servicio">
                      <mat-icon>request_quote</mat-icon>
                    </button>
                  } @else if(parte.state_closure == 2){
                    <button mat-icon-button 
                            [matMenuTriggerFor]="menuAcciones"
                            matTooltip="Generar documentos">
                      <mat-icon>more_vert</mat-icon>
                    </button>
                  } @else if (parte.state_closure == 3) {
                    <button mat-icon-button 
                            [matMenuTriggerFor]="menuAcciones"
                            matTooltip="Más opciones">
                      <mat-icon>attach_money</mat-icon>
                    </button>
                  } @else {
                    Sin proceso activo
                  }

                  <!-- Menú contextual -->
                  <mat-menu #menuAcciones="matMenu">
                    <!-- Exportar Solicitud -->
                    <button mat-menu-item (click)="generateRequest(parte.id)">
                      <mat-icon>upload_file</mat-icon>
                      <span>Exportar Solicitud</span>
                    </button>

                    <!-- Reporte de Autorización -->
                    <button mat-menu-item (click)="generateAuth(parte.id)">
                      <mat-icon>assignment</mat-icon>
                      <span>Reporte de Autorización</span>
                    </button>

                    <!-- Liquidación de Servicio -->
                    <button mat-menu-item (click)="generateLiquidation(parte.id)">
                      <mat-icon>receipt_long</mat-icon>
                      <span>Liquidación de Servicio</span>
                    </button>
                  </mat-menu>


                  
                </div>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
            
          </table>

          <!-- Mensaje cuando no hay datos -->
          <div *ngIf="partesDiariosReales.length === 0 && selectedServicio" class="no-data-message">
            <mat-icon>info</mat-icon>
            <p>No se encontraron partes diarios para el servicio seleccionado.</p>
          </div>

          <!-- Mensaje cuando no se ha seleccionado servicio -->
          <div *ngIf="!selectedServicio && !isLoading" class="no-selection-message">
            <mat-icon>search</mat-icon>
            <p>Seleccione un servicio para ver los partes diarios correspondientes.</p>
          </div>

        </mat-card-content>
      </mat-card>
</div>