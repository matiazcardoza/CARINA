<div class="dashboard-container">

  <!-- Header del Dashboard -->
  <div class="dashboard-header">
    <h1>Reportes - Partes Diarios</h1>

    <!--<div class="action-card">
      <div class="action-icon orden">ðŸ“‹</div>
       <div class="action-content">
        <h3>Nueva Orden</h3>
        <p>Registrar una nueva orden de servicio</p>
        <button class="btn btn-primary" (click)="agregarOrden()">
          Agregar Orden
        </button>
      </div>
    </div>

    <div class="action-card">
      <div class="action-icon planilla">ðŸ“Š</div>
      <div class="action-content">
        <h3>Nueva Planilla</h3>
        <p>Crear planilla de valorizaciÃ³n</p>
        <button class="btn btn-primary" (click)="nuevaPlanilla()">
          Nueva Planilla
        </button>
      </div>
    </div>-->
    <div class="action-card" *appHasPermission="'generate_reportes'">
      <button class="btn btn-primary"
        (click)="openValorizedDialog(1)">
        ðŸ’° Valorizar
      </button>
    </div>

  </div>
      <mat-card class="header-card">
        <mat-card-header>
          <div mat-card-avatar class="header-avatar">
            <mat-icon>precision_manufacturing</mat-icon>
          </div>
          <mat-card-title>Reporte Detallado</mat-card-title>
          <mat-card-subtitle>GestiÃ³n de reporte de partes diarias</mat-card-subtitle>
        </mat-card-header>
        <form [formGroup]="searchForm">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Seleccionar Servicio</mat-label>
              <input
              type="text"
              placeholder="Escriba para buscar o seleccione..."
              matInput
              formControlName="servicioSearch"
              [matAutocomplete]="auto">
              <mat-icon matSuffix>search</mat-icon>
              <button mat-icon-button matSuffix (click)="limpiarSelector()"
                      matTooltip="Limpiar selecciÃ³n"
                      type="button">
                <mat-icon>clear</mat-icon>
              </button>

              <mat-autocomplete
              #auto="matAutocomplete"
              [displayWith]="displayServicio"
              (optionSelected)="onServicioSelected($event.option.value)">

              <mat-option
                  *ngFor="let servicio of filteredServicio| async"
                  [value]="servicio"
                  class="servicio-option">

                  <div class="option-content">
                    <div class="option-header">
                        <span>CODIGO META: </span><strong>{{servicio.goal_project || 'Sin Placa'}}</strong>
                    </div>
                    <div class="option-title">{{servicio.goal_detail}}</div>
                  </div>
              </mat-option>

              <mat-option *ngIf="(filteredServicio | async)?.length === 0" disabled>
                  <div class="no-results">
                  <mat-icon>search_off</mat-icon>
                  <span>No se encontraron equipos</span>
                  </div>
              </mat-option>
            </mat-autocomplete>
          </mat-form-field>
        </form>
      </mat-card>

      <!-- Mensaje de loading -->
      <div *ngIf="isLoading" class="loading-container">
        <mat-progress-bar mode="indeterminate"></mat-progress-bar>
        <p>Cargando datos...</p>
      </div>

      <!-- Mensaje de error -->
      <div *ngIf="errorMessage" class="error-container">
        <mat-icon color="warn">error</mat-icon>
        <p>{{ errorMessage }}</p>
      </div>

      <!-- Tabla de Partes Diarios -->
      <mat-card class="table-card" *ngIf="!isLoading && !errorMessage">
        <mat-card-header>
          <mat-card-title>Partes Diarios Registrados</mat-card-title>
          <mat-card-subtitle>{{ partesDiariosReales.length }} registros encontrados</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>

          <table mat-table [dataSource]="partesDiariosReales" class="parts-table">

            <!-- Columna Estado (reemplaza Fecha) -->
            <ng-container matColumnDef="estado">
              <th mat-header-cell *matHeaderCellDef>Estado</th>
              <td mat-cell *matCellDef="let parte">
                <mat-chip-set>
                  <mat-chip [color]="obtenerColorEstado(parte.state)" selected>
                    {{ obtenerTextoEstado(parte.state) }}-{{ parte.id }}
                  </mat-chip>
                </mat-chip-set>
              </td>
            </ng-container>

            <!-- Columna Servicio/Maquinaria -->
            <ng-container matColumnDef="servicio">
              <th mat-header-cell *matHeaderCellDef>Servicio/Maquinaria</th>
              <td mat-cell *matCellDef="let parte">
                <div class="service-info">
                  <strong>{{ parte.description }}</strong>
                  <div style="color: blueviolet;" class="service-operator">
                    <mat-icon>person</mat-icon>
                    
                  </div>
                </div>
              </td>
            </ng-container>

            <!-- Columna Horas Trabajadas -->
            <ng-container matColumnDef="horasTrabajadas">
              <th mat-header-cell *matHeaderCellDef>Horas Trabajadas</th>
              <td mat-cell *matCellDef="let parte">
                <div class="hours-info">
                  <mat-icon>schedule</mat-icon>
                  {{ parte.time_worked }} hrs
                </div>
              </td>
            </ng-container>

            <!-- Columna Combustible Consumido -->
            <ng-container matColumnDef="combustibleConsumido">
              <th mat-header-cell *matHeaderCellDef>Combustible Consumido</th>
              <td mat-cell *matCellDef="let parte">
                <div class="fuel-info">
                  <mat-icon>local_gas_station</mat-icon>
                  {{ parte.fuel_consumed | number:'1.2-2' }}L
                </div>
              </td>
            </ng-container>

            <!-- Columna Evidencias (datos falsos temporales) -->
            <ng-container matColumnDef="evidencias">
              <th mat-header-cell *matHeaderCellDef>Seguimiento de Actividades</th>
              <td mat-cell *matCellDef="let parte">
                <div class="evidence-info">
                  <button style="color: rgb(106, 158, 23);" mat-icon-button matTooltip="Seguimiento de Actividades" color="primary" (click)="viewEvidenceData(parte.id, parte)">
                    <mat-icon>track_changes</mat-icon>
                  </button>
                </div>
              </td>
            </ng-container>

            <!-- Columna Acciones -->
            <ng-container matColumnDef="acciones">
              <th mat-header-cell *matHeaderCellDef>Acciones</th>
              <td mat-cell *matCellDef="let parte">
                <div class="actions-container">
                    <button mat-icon-button 
                            matTooltip="Descargar Todos los partes diarios, Completados"
                            (click)="downloadAllCompletedDailyParts(parte.id)"
                            [disabled]="isDownloading"
                            style="color: rgb(12, 92, 161);"
                            color="primary">
                      <mat-icon>{{ isDownloading ? 'hourglass_empty' : 'cloud_download' }}</mat-icon>
                    </button>
                    <button mat-icon-button *appHasPermission="'generate_reportes'"
                            matTooltip="Cerrar Servicio"
                            (click)="closeService(parte.id)"
                            style="color: rgb(161, 12, 12);"
                            color="primary">
                      <mat-icon>lock</mat-icon>
                    </button>
                    <button style="color: rgb(109, 107, 12);" *appHasPermission="'generate_reportes'" mat-icon-button
                            color="primary"
                            (click)="navigateToReportsId(parte.id, parte.state)"
                            matTooltip="Liquidar Servicio">
                      <mat-icon>account_balance_wallet</mat-icon>
                    </button>
                </div>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>

          </table>

          <!-- Mensaje cuando no hay datos -->
          <div *ngIf="partesDiariosReales.length === 0 && selectedServicio" class="no-data-message">
            <mat-icon>info</mat-icon>
            <p>No se encontraron partes diarios para el servicio seleccionado.</p>
          </div>

          <!-- Mensaje cuando no se ha seleccionado servicio -->
          <div *ngIf="!selectedServicio && !isLoading" class="no-selection-message">
            <mat-icon>search</mat-icon>
            <p>Seleccione un servicio para ver los partes diarios correspondientes.</p>
          </div>

        </mat-card-content>
      </mat-card>
</div>
