<div class="reports-container">
  <!-- Header -->
  <div class="header">
    <div class="header-left">
      <h1>Liquidaci√≥n de Servicio</h1>
      <p class="subtitle">Gesti√≥n de documentos y reportes</p>
    </div>
    <div class="header-right">
      <span class="badge badge-id">ID: {{ reportId }}</span>
      <span class="badge" [ngClass]="getBadgeClass(state)">
        {{ getStateText(state) }}
      </span>
    </div>
  </div>

  <!-- Error Message -->
  <div class="alert alert-error" *ngIf="errorMessage">
    <span class="alert-icon">‚ö†Ô∏è</span>
    <span>{{ errorMessage }}</span>
    <button class="alert-close" (click)="errorMessage = null">‚úï</button>
  </div>

  <!-- Main Content -->
  <div class="content-grid">
    
    <!-- Left Panel - Information Summary -->
    <div class="left-panel">
      <!-- Equipo y Operador -->
      <div class="info-card" *ngIf="equipmentData">
        <div class="info-card-header">
          <span class="info-icon">üöú</span>
          <h2>Equipo y Operador</h2>
        </div>
        <div class="info-card-body">
          <div class="info-item">
            <span class="info-label">Equipo:</span>
            <span class="info-value">{{ equipmentData.machinery_equipment + ' ' +equipmentData.model }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Marca:</span>
            <span class="info-value">{{ equipmentData.brand }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Placa:</span>
            <span class="info-value">{{ equipmentData.plate }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Operador:</span>
            <span class="info-value">
                <span *ngFor="let op of equipmentData.operators; let i = index">
                {{ op.name }}<span *ngIf="i < equipmentData.operators.length - 1">, </span>
                </span>
            </span>
          </div>
        </div>
      </div>

      <!-- Estado de Documentos -->
      <div class="info-card">
        <div class="info-card-header">
          <span class="info-icon">üìÑ</span>
          <h2>Estado de Documentos</h2>
        </div>
        <div class="info-card-body">
          <div class="document-status-item" [class.completed]="documentStatus.solicitud">
            <span class="status-icon">{{ documentStatus.solicitud ? '‚úì' : '‚óã' }}</span>
            <span class="status-text">Solicitud de Movilidad</span>
          </div>
          <div class="document-status-item" [class.completed]="documentStatus.autorizacion">
            <span class="status-icon">{{ documentStatus.autorizacion ? '‚úì' : '‚óã' }}</span>
            <span class="status-text">Autorizaci√≥n de Servicio</span>
          </div>
          <div class="document-status-item" [class.completed]="documentStatus.liquidacion">
            <span class="status-icon">{{ documentStatus.liquidacion ? '‚úì' : '‚óã' }}</span>
            <span class="status-text">Liquidaci√≥n de Servicio</span>
          </div>
        </div>
      </div>

    </div>

    <!-- Right Panel - Document Preview -->
    <div class="right-panel" *ngIf="requestData">
      
      <!-- Document Selector -->
      <div class="document-tabs">
        <button 
          class="tab-button" 
          [class.active]="activeDocument === 'solicitud'"
          (click)="changeDocument('solicitud')">
          <span class="tab-icon">üìã</span>
          Solicitud de Movilidad
        </button>
        <button 
          class="tab-button" 
          [class.active]="activeDocument === 'autorizacion'"
          (click)="changeDocument('autorizacion')">
          <span class="tab-icon">‚úÖ</span>
          Autorizaci√≥n de Servicio
        </button>
        <button 
          class="tab-button" 
          [class.active]="activeDocument === 'liquidacion'"
          (click)="changeDocument('liquidacion')">
          <span class="tab-icon">üí∞</span>
          Liquidaci√≥n de Servicio
        </button>
      </div>

      <!-- Document Preview -->
      <div class="document-preview">
        
        <!-- Solicitud de Movilidad Preview -->
        <div class="preview-document" *ngIf="activeDocument === 'solicitud'">
          <h2 class="document-title">SOLICITUD DE MOVILIDAD</h2>

          <div class="document-body">
            <div class="form-row">
              <span class="form-label">√ìRGANO/UNIDAD ORG√ÅNICA SOLICITANTE:</span>
              <span class="form-value">SUB GERENCIA DE OBRAS</span>
            </div>
            <div class="form-row">
              <span class="form-label">FECHA:</span>
              <span class="form-value">{{ requestData.minDate }}</span>
            </div>
            <div class="form-row">
              <span class="form-label">OBJETIVO DE LA COMISI√ìN:</span>
              <span class="form-value">{{ requestData.goal_detail }}</span>
            </div>
            <div class="form-row">
              <span class="form-label">DESTINO:</span>
              <span class="form-value">{{ requestData.goal_detail }}</span>
            </div>
            <div class="form-row">
              <span class="form-label">DURACI√ìN:</span>
              <span class="form-value">DEL: {{ requestData.minDate }} AL: {{ requestData.maxDate }}</span>
            </div>
            <div class="form-row">
              <span class="form-label">HORA:</span>
              <span class="form-value">Salida: {{ requestData.minStartTime }} Retorno: {{ requestData.maxEndTime }}</span>
            </div>
            <div class="form-row">
              <span class="form-label">MOVILIDAD / PLACA:</span>
              <span class="form-value">{{ equipmentData.machinery_equipment + ' ' +equipmentData.plate }}</span>
            </div>
            <div class="form-row">
              <span class="form-label">CHOFER / OPERARIO:</span>
                <span class="from-value">
                    <span *ngFor="let op of equipmentData.operators; let i = index">
                    {{ op.name }}<span *ngIf="i < equipmentData.operators.length - 1">, </span>
                    </span>
                </span>
            </div>
          </div>

          <div class="document-footer">
            <button class="btn btn-primary btn-lg" (click)="generateRequest()">
              <span class="btn-icon">üìÑ</span>
              Generar Solicitud de Movilidad
            </button>
          </div>
        </div>

        <!-- Autorizaci√≥n de Servicio Preview -->
        <div class="preview-document" *ngIf="activeDocument === 'autorizacion'">
            <div class="document-header">
                <h3>REPORTE DIARIO DE AUTORIZACI√ìN DE SERVICIO/MAQUINARIA GRP</h3>
                
                <!-- Botones de control de edici√≥n -->
                <div class="edit-controls">
                <button 
                    *ngIf="!editMode" 
                    class="btn btn-secondary" 
                    (click)="enableEditMode()">
                    <span class="btn-icon">‚úèÔ∏è</span>
                    Editar Datos
                </button>
                
                <div *ngIf="editMode" class="edit-buttons-group">
                    <button class="btn btn-success" (click)="saveAuthChanges()" [disabled]="!hasUnsavedChanges">
                    <span class="btn-icon">üíæ</span>
                    Guardar Cambios
                    </button>
                    <button class="btn btn-danger" (click)="cancelEdit()">
                    <span class="btn-icon">‚úñÔ∏è</span>
                    Cancelar
                    </button>
                </div>
                </div>
            </div>

            <div class="document-body">
                <!-- Info b√°sica -->
                <div class="form-row">
                <span class="form-label">UND ORG√ÅNICA SOLICITANTE:</span>
                <span class="form-value">SUB GERENCIA DE OBRAS</span>
                </div>
                <div class="form-row">
                <span class="form-label">OBRA:</span>
                <span class="form-value">{{ requestData.goal_detail }}</span>
                </div>
                <div class="form-row">
                <span class="form-label">OPERADOR:</span>
                <span class="form-value">
                    <span *ngFor="let op of equipmentData.operators; let i = index">
                    {{ op.name }}<span *ngIf="i < equipmentData.operators.length - 1">, </span>
                    </span>
                </span>
                </div>
                <div class="form-row">
                <span class="form-label">M√ÅQUINA:</span>
                <span class="form-value">{{ equipmentData.machinery_equipment }} - MARCA: {{ equipmentData.brand }} - PLACA/MODELO: {{ equipmentData.plate + '/' + equipmentData.model}}</span>
                </div>
                <div class="form-row">
                <span class="form-label">PER√çODO:</span>
                <span class="form-value">{{ (editMode ? editedAuthData : authData).minDate }} - {{ (editMode ? editedAuthData : authData).maxDate }}</span>
                </div>

                <!-- Botones para agregar fila arriba -->
                <div *ngIf="editMode" class="row-actions-top">
                <button class="btn btn-sm btn-info" (click)="addRowTop()">
                    <span class="btn-icon">‚ûï</span>
                    Agregar Fila Arriba
                </button>
                </div>

                <div class="table-container">
                <table class="work-table">
                    <thead>
                    <tr>
                        <th>FECHA</th>
                        <th>HM TRABAJADAS</th>
                        <th>HM EQUIVALENTE</th>
                        <th>CONSUMO COMBUSTIBLE</th>
                        <th>D√çAS TRABAJADOS</th>
                        <th>COSTO HORA S/.</th>
                        <th>IMPORTE TOTAL S/.</th>
                        <th *ngIf="editMode">ACCIONES</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr *ngFor="let dia of (editMode ? editedAuthData : authData).processedData; let i = index" 
                        [class.no-work]="dia.has_work === false"
                        [class.new-row]="dia.isNew">
                        
                        <!-- Fecha (no editable) -->
                        <td>{{ dia.date }}</td>
                        
                        <!-- HM Trabajadas (editable) -->
                        <td 
                        [contentEditable]="editMode"
                        [class.editable]="editMode"
                        (dblclick)="onCellDoubleClick(i, 'time_worked')"
                        (blur)="updateCellValue(i, 'time_worked', $event)"
                        [attr.data-field]="'time_worked'">
                        {{ dia.time_worked }}
                        </td>
                        
                        <!-- HM Equivalente (calculado) -->
                        <td>{{ dia.equivalent_hours > 0 ? dia.equivalent_hours : '-' }}</td>
                        
                        <!-- Consumo Combustible (editable) -->
                        <td 
                        [contentEditable]="editMode"
                        [class.editable]="editMode"
                        (dblclick)="onCellDoubleClick(i, 'fuel_consumption')"
                        (blur)="updateCellValue(i, 'fuel_consumption', $event)"
                        [attr.data-field]="'fuel_consumption'">
                        {{ dia.fuel_consumption > 0 ? dia.fuel_consumption : '-' }}
                        </td>

                        
                        <!-- D√≠as Trabajados (no editable) -->
                        <td>{{ dia.days_worked !== '-' ? dia.days_worked : '-' }}</td>
                        
                        <!-- Costo Hora (editable) -->
                        <td>
                            S/ {{ dia.cost_per_hour }}
                        </td>
                        
                        <!-- Importe Total (calculado) -->
                        <td>S/ {{ dia.total_amount }}</td>
                        
                        <!-- Acciones -->
                        <td *ngIf="editMode">
                        <button 
                            class="btn-icon-delete" 
                            (click)="deleteRow(i)"
                            title="Eliminar fila">
                            üóëÔ∏è
                        </button>
                        </td>
                    </tr>
                    
                    <!-- Fila de totales -->
                    <tr class="total-row">
                        <td colspan="1">TOTAL</td>
                        <td>{{ (editMode ? editedAuthData : authData).totals.time_worked }}</td>
                        <td>{{ (editMode ? editedAuthData : authData).totals.equivalent_hours }}</td>
                        <td>{{ (editMode ? editedAuthData : authData).totals.fuel_consumption }}</td>
                        <td>{{ (editMode ? editedAuthData : authData).totals.days_worked }}</td>
                        <td>S/ {{ (editMode ? editedAuthData : authData).totals.cost_per_hour }}</td>
                        <td><strong>S/ {{ (editMode ? editedAuthData : authData).totals.total_amount }}</strong></td>
                        <td *ngIf="editMode"></td>
                    </tr>
                    </tbody>
                </table>
                </div>

                <!-- Botones para agregar fila abajo -->
                <div *ngIf="editMode" class="row-actions-bottom">
                <button class="btn btn-sm btn-info" (click)="addRowBottom()">
                    <span class="btn-icon">‚ûï</span>
                    Agregar Fila Abajo
                </button>
                </div>

                <!-- Resumen -->
                <div class="summary-box">
                <h4>RESUMEN</h4>
                <div class="summary-grid">
                    <div class="summary-item">
                    <span class="summary-label">HORAS TRABAJADAS:</span>
                    <span class="summary-value">{{ (editMode ? editedAuthData : authData).totals.time_worked }}</span>
                    </div>
                    <div class="summary-item">
                    <span class="summary-label">HORA EQUIVALENTE:</span>
                    <span class="summary-value">{{ (editMode ? editedAuthData : authData).totals.equivalent_hours }}</span>
                    </div>
                    <div class="summary-item">
                    <span class="summary-label">COSTO HM:</span>
                    <span class="summary-value">S/ {{ (editMode ? editedAuthData : authData).totals.cost_per_hour }}</span>
                    </div>
                    <div class="summary-item total">
                    <span class="summary-label">IMPORTE A PAGAR S/.:</span>
                    <span class="summary-value">{{ (editMode ? editedAuthData : authData).totals.total_amount }}</span>
                    </div>
                </div>
                </div>
            </div>

            <div class="document-footer">
                <button class="btn btn-success btn-lg" (click)="generateAuth()">
                <span class="btn-icon">‚úÖ</span>
                Generar Autorizaci√≥n de Servicio
                </button>
            </div>
        </div>

        <!-- Liquidaci√≥n de Servicio Preview -->
        <div class="preview-document" *ngIf="activeDocument === 'liquidacion'">
          <h2 class="document-title">LIQUIDACI√ìN DE SERVICIO DE ALQUILER</h2>

          <div class="document-body">
            <div class="form-row">
              <span class="form-label">FECHA:</span>
              <span class="form-value">{{ today | date:'dd/MM/yyyy' }}</span>
            </div>
            <div class="form-row">
              <span class="form-label">USUARIO SOLICITANTE:</span>
              <span class="form-value">SUB GERENCIA DE OBRAS</span>
            </div>
            <div class="form-row">
              <span class="form-label">DIRECCI√ìN:</span>
              <span class="form-value">JR. MOQUEGUA N¬∞ 269-A</span>
            </div>
            <div class="form-row">
              <span class="form-label">SERVICIO ALQUILADO:</span>
              <span class="form-value">{{ equipmentData.machinery_equipment  + ' ' + equipmentData.model + ' ' + equipmentData.plate}}</span>
            </div>
            <div class="form-row">
              <span class="form-label">PERIODO DE ALQUILER:</span>
              <span class="form-value">DEL {{ requestData.minDate }} AL {{ requestData.maxDate }} HORAS: DE {{ requestData.minStartTime }} A {{ requestData.maxEndTime }}</span>
            </div>
            <div class="form-row">
                <span class="form-label">TOTAL D√çAS/HORAS:</span>
                <span class="form-value">D√≠as {{ (editMode ? editedAuthData : authData).totals.days_worked }} Horas {{ (editMode ? editedAuthData : authData).totals.equivalent_hours }}</span>
            </div>
            <div class="form-row">
                <span class="form-label">COSTO DEL SERVICIO:</span>
                <span class="form-value">POR D√çA: S/. {{ getCostPerDay() }} POR HORA S/. {{ (editMode ? editedAuthData : authData).totals.cost_per_hour }}</span>
            </div>

            <div class="cost-summary">
              <div class="cost-row total-cost">
                <span class="cost-label">TOTAL:</span>
                <span class="cost-value">S/. {{ (editMode ? editedAuthData : authData).totals.total_amount }}</span>
              </div>
              <div class="cost-row">
                <span class="cost-label">TOTAL (EN LETRAS):</span>
                <span class="cost-value">{{ getTotalInWords() }}</span>
              </div>
            </div>
          </div>

          <div class="document-footer">
            <button class="btn btn-warning btn-lg" (click)="generateLiquidation()">
              <span class="btn-icon">üí∞</span>
              Generar Liquidaci√≥n de Servicio
            </button>
          </div>
        </div>

      </div>
    </div>

  </div>
</div>