<div class="dialog-container">
  <h2 mat-dialog-title>{{ title }}</h2>
  
  <mat-dialog-content>
    <form [formGroup]="usersForm" class="users-form" autocomplete="off">
      
      <!-- Campo de DNI -->
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>DNI</mat-label>
        <input matInput 
               formControlName="num_doc"
               placeholder="Ingrese 8 dígitos"
               maxlength="8"
               type="text"
               inputmode="numeric"
               pattern="[0-9]*"
               (input)="onDniInput($event)"
               autocomplete="off">
        <mat-icon matSuffix *ngIf="isSearchingDni">hourglass_empty</mat-icon>
        <mat-icon matSuffix *ngIf="!isSearchingDni && usersForm.get('num_doc')?.value?.length === 8">search</mat-icon>
        <mat-hint *ngIf="!isSearchingDni">Al completar 8 dígitos se buscarán los datos automáticamente</mat-hint>
        <mat-hint *ngIf="isSearchingDni">Buscando datos...</mat-hint>
        <mat-error *ngIf="usersForm.get('num_doc')?.hasError('required')">
          El DNI es requerido
        </mat-error>
        <mat-error *ngIf="usersForm.get('num_doc')?.hasError('pattern')">
          El DNI debe contener exactamente 8 dígitos
        </mat-error>
      </mat-form-field>

      <!-- Fila con Nombres y Apellidos -->
      <div class="form-row">
        <mat-form-field appearance="outline" class="half-width">
          <mat-label>Nombres</mat-label>
          <input matInput 
                 formControlName="persona_name"
                 placeholder="Nombres completos"
                 maxlength="100"
                 autocomplete="off">
          <mat-error *ngIf="usersForm.get('persona_name')?.hasError('required')">
            Los nombres son requeridos
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="half-width">
          <mat-label>Apellidos</mat-label>
          <input matInput 
                 formControlName="last_name"
                 placeholder="Apellidos completos"
                 maxlength="100"
                 autocomplete="off">
          <mat-error *ngIf="usersForm.get('last_name')?.hasError('required')">
            Los apellidos son requeridos
          </mat-error>
        </mat-form-field>
      </div>

      <!-- Campo de Nombre de Usuario -->
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Nombre de Usuario</mat-label>
        <input matInput 
               formControlName="username"
               placeholder="Nombre de usuario único"
               maxlength="50"
               autocomplete="new-username">
        <mat-error *ngIf="usersForm.get('username')?.hasError('required')">
          El nombre de usuario es requerido
        </mat-error>
      </mat-form-field>

      <!-- Campo de Correo Electrónico -->
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Correo Electrónico</mat-label>
        <input matInput 
               type="email"
               formControlName="email"
               placeholder="usuario@ejemplo.com"
               maxlength="100"
               autocomplete="off">
        <mat-error *ngIf="usersForm.get('email')?.hasError('required')">
          El correo electrónico es requerido
        </mat-error>
        <mat-error *ngIf="usersForm.get('email')?.hasError('email')">
          Ingrese un correo electrónico válido
        </mat-error>
      </mat-form-field>

      <!-- Campos de Contraseña -->
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>{{ data.isEdit ? 'Nueva Contraseña (Opcional)' : 'Contraseña' }}</mat-label>
        <input matInput 
               [type]="hidePassword ? 'password' : 'text'"
               formControlName="password"
               [placeholder]="data.isEdit ? 'Dejar vacío para mantener actual' : 'Mínimo 8 caracteres'"
               autocomplete="new-password">
        <button mat-icon-button matSuffix 
                type="button"
                (click)="togglePasswordVisibility()" 
                [attr.aria-label]="'Hide password'" 
                [attr.aria-pressed]="hidePassword">
          <mat-icon>{{hidePassword ? 'visibility_off' : 'visibility'}}</mat-icon>
        </button>
        <mat-hint *ngIf="!data.isEdit">
          Puede contener: mayúscula, minúscula, número y símbolo
        </mat-hint>
        <mat-error *ngIf="usersForm.get('password')?.hasError('required')">
          La contraseña es requerida
        </mat-error>
        <mat-error *ngIf="usersForm.get('password')?.hasError('minlength')">
          Mínimo 8 caracteres
        </mat-error>
        <mat-error *ngIf="usersForm.get('password')?.hasError('pattern')">
          Debe incluir mayúscula, minúscula, número y símbolo
        </mat-error>
      </mat-form-field>

      <!-- Campo de Confirmar Contraseña (solo en modo creación o si hay contraseña en edición) -->
      <mat-form-field appearance="outline" class="full-width" 
                      *ngIf="!data.isEdit || (data.isEdit && usersForm.get('password')?.value)">
        <mat-label>Confirmar Contraseña</mat-label>
        <input matInput 
               [type]="hideConfirmPassword ? 'password' : 'text'"
               formControlName="confirmPassword"
               placeholder="Confirme su contraseña"
               autocomplete="new-password">
        <button mat-icon-button matSuffix 
                type="button"
                (click)="toggleConfirmPasswordVisibility()" 
                [attr.aria-label]="'Hide password'" 
                [attr.aria-pressed]="hideConfirmPassword">
          <mat-icon>{{hideConfirmPassword ? 'visibility_off' : 'visibility'}}</mat-icon>
        </button>
        <mat-error *ngIf="usersForm.get('confirmPassword')?.hasError('required')">
          Debe confirmar la contraseña
        </mat-error>
        <mat-error *ngIf="usersForm.hasError('passwordMismatch') && usersForm.get('confirmPassword')?.touched">
          Las contraseñas no coinciden
        </mat-error>
      </mat-form-field>

      <!-- Sección de Roles con Checkboxes -->
      <div class="roles-section">
        <label class="roles-label">Roles *</label>
        
        <!-- Mostrar loader mientras se cargan los roles -->
        <div *ngIf="isLoadingRoles" class="roles-loading">
          <mat-icon>hourglass_empty</mat-icon>
          <span>Cargando roles...</span>
        </div>
        
        <!-- Mostrar checkboxes cuando los roles están cargados -->
        <div *ngIf="!isLoadingRoles" class="roles-checkboxes" formArrayName="roles">
          <mat-checkbox 
            *ngFor="let role of roleOptions; let i = index"
            [formControlName]="i"
            class="role-checkbox"
            (change)="onRoleChange(i, $event)">
            {{ role.label }}
          </mat-checkbox>
        </div>
        
        <div class="roles-error" *ngIf="rolesFormArray.hasError('noRoleSelected') && rolesFormArray.touched">
          Debe seleccionar al menos un rol
        </div>
      </div>

      <!-- Campo de Estado -->
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Estado</mat-label>
        <mat-select formControlName="state">
          <mat-option *ngFor="let state of stateOptions" [value]="state.value">
            {{ state.label }}
          </mat-option>
        </mat-select>
        <mat-error *ngIf="usersForm.get('state')?.hasError('required')">
          El estado es requerido
        </mat-error>
      </mat-form-field>
    </form>
    
  </mat-dialog-content>

  <mat-dialog-actions align="end">
    <button mat-button 
            (click)="onCancel()" 
            [disabled]="isLoading">
      Cancelar
    </button>
    
    <button mat-raised-button 
            color="primary" 
            (click)="onSubmit()"
            [disabled]="isLoading || usersForm.invalid">
      <span *ngIf="isLoading">Guardando...</span>
      <span *ngIf="!isLoading">{{ submitButtonText }}</span>
    </button>
  </mat-dialog-actions>
</div>