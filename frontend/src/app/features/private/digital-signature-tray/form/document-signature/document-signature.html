<div class="fullscreen-signature-container">
  <mat-toolbar color="primary" class="signature-toolbar">
    <span>Documento de parte diaria - Reporte de Fecha</span>
    <span class="toolbar-spacer"></span>

    <!-- Indicador de estado de firma -->
    <div *ngIf="isSigned" class="signature-status">
      <mat-icon class="signed-icon">check_circle</mat-icon>
      <span class="signed-text">Firmado</span>
    </div>

    <button mat-icon-button
            (click)="onCancel()"
            matTooltip="Cancelar">
      <mat-icon>close</mat-icon>
    </button>
  </mat-toolbar>

  <div class="pdf-container">
    <!-- Loading spinner -->
    <div *ngIf="isLoading" class="loading-container">
      <mat-spinner diameter="50"></mat-spinner>
      <p>Cargando documento...</p>
    </div>

    <!-- Error message -->
    <div *ngIf="error && !isLoading" class="error-container">
      <mat-icon class="error-icon">error</mat-icon>
      <p>{{ error }}</p>
      <button mat-raised-button color="primary" (click)="onRetry()">
        <mat-icon>refresh</mat-icon>
        Reintentar
      </button>
    </div>

    <!-- PDF Viewer -->
    <iframe
      *ngIf="pdfUrl && !isLoading && !error"
      [src]="pdfUrl"
      class="pdf-viewer"
      frameborder="0">
    </iframe>
  </div>

  <!-- Sección de firma (nueva) -->
  <div *ngIf="pdfUrl && !isLoading && !error" class="signature-section">
    <div class="signature-info">
      <mat-icon [class]="isSigned ? 'signature-icon signed' : 'signature-icon'">
        {{ isSigned ? 'verified' : 'edit' }}
      </mat-icon>
      <span class="signature-text">
        {{ isSigned ? 'Documento firmado digitalmente' : 'Documento pendiente de firma' }}
      </span>
    </div>
    <button *ngIf="hasResidentRole() && documentState !== 2"
            mat-raised-button
            color="primary"
            [disabled]="isLoading"
            (click)="toggleReturnSection()"
            class="return-button">
      <mat-icon>keyboard_return</mat-icon>
      {{ showReturnSection ? 'Cancelar devolución' : 'Devolver a controlador' }}
    </button>
    <button *ngIf="shouldShowSignButton()"
          mat-raised-button
          [color]="isSigned ? 'accent' : 'warn'"
          [disabled]="isLoading || isSigningInProgress"
          (click)="onSign()"
          class="sign-button">
    <mat-icon>{{ isSigned ? 'refresh' : 'create' }}</mat-icon>
    {{ isSigned ? 'Firmar nuevamente' : 'Firmar documento' }}
  </button>
  </div>

  <div *ngIf="showReturnSection && hasResidentRole()" class="return-section">
    <form [formGroup]="userForm">
      <mat-form-field appearance="outline" class="observation-field">
        <mat-label>Observación de devolución</mat-label>
        <textarea matInput
            formControlName="observation"
            placeholder="Ingrese el motivo de la devolución..."
            rows="3"
            required></textarea>
        <mat-error *ngIf="userForm.get('observation')?.hasError('required')">
          La observación es requerida
        </mat-error>
      </mat-form-field>
      
      <div class="return-actions">
        <button mat-raised-button
                color="warn"
                [disabled]="!userForm.get('observation')?.value?.trim()"
                (click)="onReturnToController()">
          <mat-icon>undo</mat-icon>
          Confirmar devolución
        </button>
      </div>
    </form>
  </div>

  <mat-toolbar class="signature-actions" *ngIf="!showReturnSection">
    <form [formGroup]="userForm" class="user-selector-form">
      <mat-form-field appearance="outline" class="user-selector-field dense-form-field">
        <input type="text"
              placeholder="NOMBRE - DNI - CORREO"
              aria-label="Usuarios"
              matInput
              formControlName="userId"
              [matAutocomplete]="autoUser">
        
        <!-- BOTÓN PARA LIMPIAR SELECCIÓN -->
        <button mat-icon-button matSuffix 
                *ngIf="userForm.get('userId')?.value"
                (click)="clearUserSelection($event)"
                type="button"
                matTooltip="Limpiar selección">
          <mat-icon>close</mat-icon>
        </button>
        
        <mat-autocomplete #autoUser="matAutocomplete"
                          [displayWith]="displayUser"
                          (optionSelected)="onUserSelected($event.option.value)">
          <mat-option *ngFor="let user of filteredUsers" [value]="user">
            {{ user.persona_name }} {{ user.last_name }} {{ user.num_doc }} - {{ user.email }}
          </mat-option>
        </mat-autocomplete>
        
        <mat-error *ngIf="userForm.get('userId')?.hasError('required')">
          El usuario es requerido
        </mat-error>
      </mat-form-field>
    </form>

    <button mat-raised-button
            color="warn"
            [disabled]="!userForm.valid"
            [class.pulse-button]="!userForm.valid"
            (click)="onSend()">
      <mat-icon>send</mat-icon>
      Enviar documento
    </button>
  </mat-toolbar>
</div>
