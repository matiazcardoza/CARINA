<!-- Header del módulo -->
<div class="fuel-control-container">
  <mat-card class="header-card">
    <mat-card-header>
      <div mat-card-avatar class="header-avatar">
        <mat-icon>local_gas_station</mat-icon>
      </div>
      <mat-card-title>Control de Combustible</mat-card-title>
      <mat-card-subtitle>Gestión de consumo para maquinarias secas</mat-card-subtitle>
    </mat-card-header>
  </mat-card>

  <!-- Resumen de estadísticas -->
  <div class="stats-row">
    <mat-card class="stat-card">
      <mat-card-content>
        <div class="stat-content">
          <mat-icon class="stat-icon">assessment</mat-icon>
          <div class="stat-info">
            <h3>{{ getTotalCombustibleConsumido() | number:'1.1-1' }} L</h3>
            <p>Total Consumido</p>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="stat-card">
      <mat-card-content>
        <div class="stat-content">
          <mat-icon class="stat-icon">speed</mat-icon>
          <div class="stat-info">
            <h3>{{ getPromedioCombustible() | number:'1.1-1' }} L</h3>
            <p>Promedio por Parte</p>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="stat-card">
      <mat-card-content>
        <div class="stat-content">
          <mat-icon class="stat-icon">construction</mat-icon>
          <div class="stat-info">
            <h3>{{ serviciosMaquinaria.length }}</h3>
            <p>Maquinarias Activas</p>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Formulario de actualización (cuando se selecciona un parte) -->
  <mat-card *ngIf="selectedParte" class="edit-form-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>edit</mat-icon>
        Actualizar Combustible - {{ selectedParte.nombre_servicio }}
      </mat-card-title>
      <mat-card-subtitle>
        Parte del {{ selectedParte.fecha_parte | date:'dd/MM/yyyy' }} 
        ({{ selectedParte.hora_inicio }} - {{ selectedParte.hora_fin }})
      </mat-card-subtitle>
    </mat-card-header>
    
    <mat-card-content>
      <div class="form-row">
        <mat-form-field appearance="outline" class="form-field">
          <mat-label>Combustible Inicial (L)</mat-label>
          <input matInput 
                 type="number" 
                 [(ngModel)]="combustibleInicialTemp"
                 min="0"
                 step="0.1">
          <mat-icon matSuffix>local_gas_station</mat-icon>
        </mat-form-field>

        <mat-form-field appearance="outline" class="form-field">
          <mat-label>Combustible Final (L)</mat-label>
          <input matInput 
                 type="number" 
                 [(ngModel)]="combustibleFinalTemp"
                 min="0"
                 step="0.1">
          <mat-icon matSuffix>local_gas_station</mat-icon>
        </mat-form-field>

        <div class="consumption-display">
          <mat-icon>timeline</mat-icon>
          <div class="consumption-info">
            <h4>{{ (combustibleInicialTemp - combustibleFinalTemp) | number:'1.1-1' }} L</h4>
            <p>Consumo Calculado</p>
          </div>
        </div>
      </div>

      <div class="validation-message" *ngIf="!validarCombustible() && combustibleFinalTemp > 0">
        <mat-icon color="warn">warning</mat-icon>
        <span>El combustible final debe ser menor al inicial</span>
      </div>
    </mat-card-content>

    <mat-card-actions align="end">
      <button mat-button (click)="cancelarEdicion()">
        <mat-icon>close</mat-icon>
        Cancelar
      </button>
      <button mat-raised-button 
              color="primary" 
              (click)="actualizarCombustible()"
              [disabled]="!validarCombustible()">
        <mat-icon>save</mat-icon>
        Actualizar
      </button>
    </mat-card-actions>
  </mat-card>

  <!-- Tabla de partes diarios con control de combustible -->
  <mat-card class="table-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>format_list_bulleted</mat-icon>
        Partes Diarios - Control de Combustible
      </mat-card-title>
      <mat-card-subtitle>
        Listado de maquinarias secas con registro de combustible
      </mat-card-subtitle>
    </mat-card-header>

    <mat-card-content>
      <div class="table-container">
        <table mat-table [dataSource]="partesDiarios" class="fuel-table">
          
          <!-- Columna Código -->
          <ng-container matColumnDef="codigo">
            <th mat-header-cell *matHeaderCellDef>Código</th>
            <td mat-cell *matCellDef="let parte">
              <div class="code-cell">
                <mat-icon>precision_manufacturing</mat-icon>
                {{ getCodigoServicio(parte.id_servicio) }}
              </div>
            </td>
          </ng-container>

          <!-- Columna Servicio -->
          <ng-container matColumnDef="nombre_servicio">
            <th mat-header-cell *matHeaderCellDef>Maquinaria</th>
            <td mat-cell *matCellDef="let parte">
              <div class="service-cell">
                <strong>{{ parte.nombre_servicio }}</strong>
              </div>
            </td>
          </ng-container>

          <!-- Columna Fecha -->
          <ng-container matColumnDef="fecha_parte">
            <th mat-header-cell *matHeaderCellDef>Fecha</th>
            <td mat-cell *matCellDef="let parte">
              <div class="date-cell">
                <mat-icon>event</mat-icon>
                {{ parte.fecha_parte | date:'dd/MM/yyyy' }}
                <br>
                <small>{{ parte.hora_inicio }} - {{ parte.hora_fin }}</small>
              </div>
            </td>
          </ng-container>

          <!-- Columna Horas Trabajadas -->
          <ng-container matColumnDef="horas_trabajadas">
            <th mat-header-cell *matHeaderCellDef>Horas</th>
            <td mat-cell *matCellDef="let parte">
              <div class="hours-cell">
                <mat-icon>schedule</mat-icon>
                {{ parte.horas_trabajadas }}h
              </div>
            </td>
          </ng-container>

          <!-- Columna Combustible Inicial -->
          <ng-container matColumnDef="combustible_inicial">
            <th mat-header-cell *matHeaderCellDef>Inicial (L)</th>
            <td mat-cell *matCellDef="let parte">
              <div class="fuel-cell initial">
                {{ parte.combustible_inicial | number:'1.1-1' }}
              </div>
            </td>
          </ng-container>

          <!-- Columna Combustible Final -->
          <ng-container matColumnDef="combustible_final">
            <th mat-header-cell *matHeaderCellDef>Final (L)</th>
            <td mat-cell *matCellDef="let parte">
              <div class="fuel-cell final">
                {{ parte.combustible_final | number:'1.1-1' }}
              </div>
            </td>
          </ng-container>

          <!-- Columna Combustible Consumido -->
          <ng-container matColumnDef="combustible_consumido">
            <th mat-header-cell *matHeaderCellDef>Consumido (L)</th>
            <td mat-cell *matCellDef="let parte">
              <div class="fuel-cell consumed">
                <strong>{{ parte.combustible_consumido | number:'1.1-1' }}</strong>
                <br>
                <small>({{ getConsumoPromedio(parte) }} L/h)</small>
              </div>
            </td>
          </ng-container>

          <!-- Columna Estado -->
          <ng-container matColumnDef="estado">
            <th mat-header-cell *matHeaderCellDef>Estado</th>
            <td mat-cell *matCellDef="let parte">
              <div class="status-cell">
                <mat-icon [class]="'status-icon ' + parte.estado.toLowerCase()">
                  {{ parte.estado === 'Pendiente' ? 'pending' : 'check_circle' }}
                </mat-icon>
                <span [class]="'status-text ' + parte.estado.toLowerCase()">
                  {{ parte.estado }}
                </span>
              </div>
            </td>
          </ng-container>

          <!-- Columna Acciones -->
          <ng-container matColumnDef="acciones">
            <th mat-header-cell *matHeaderCellDef>Acciones</th>
            <td mat-cell *matCellDef="let parte">
              <div class="actions-cell">
                <button mat-icon-button 
                        color="primary"
                        (click)="editarCombustible(parte)"
                        [disabled]="selectedParte?.id_parte === parte.id_parte"
                        matTooltip="Actualizar combustible">
                  <mat-icon>edit</mat-icon>
                </button>
                
                <button mat-icon-button 
                        color="accent"
                        matTooltip="Ver detalles">
                  <mat-icon>visibility</mat-icon>
                </button>
              </div>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;"
              [class.selected-row]="selectedParte?.id_parte === row.id_parte"></tr>
        </table>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Información adicional -->
  <mat-card class="info-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>info</mat-icon>
        Información del Módulo
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <p>
        <strong>Función:</strong> Este módulo permite gestionar y registrar el consumo de combustible 
        específicamente para maquinarias secas, actualizando los campos combustible_inicial y 
        combustible_final en los partes diarios.
      </p>
      <p>
        <strong>Operación:</strong> UPDATE - Se actualiza la información de combustible y se recalculan 
        automáticamente los campos derivados como combustible_consumido.
      </p>
      <div class="legend">
        <div class="legend-item">
          <mat-icon class="status-icon pendiente">pending</mat-icon>
          <span>Pendiente de actualización</span>
        </div>
        <div class="legend-item">
          <mat-icon class="status-icon actualizado">check_circle</mat-icon>
          <span>Combustible actualizado</span>
        </div>
      </div>
    </mat-card-content>
  </mat-card>
</div>